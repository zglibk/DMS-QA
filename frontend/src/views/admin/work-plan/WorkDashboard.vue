<template>
    <el-card class="modern-dashboard">
      <!-- È°µÈù¢Ê†áÈ¢òÂíåÊó∂Èó¥ËåÉÂõ¥ÈÄâÊã© -->
      <div class="page-header">
        <div class="header-content">
          <div class="header-left">
            <h1 class="page-title">
              <el-icon class="title-icon"><DataBoard /></el-icon>
              Â∑•‰ΩúÂè∞
            </h1>
            <div class="welcome-message">
              <p class="welcome-line">
                <span class="greeting-section">
                  <span class="greeting-emoji">{{ getGreeting().split(' ')[1] || 'üëã' }}</span>
                  <span class="greeting-words">{{ getGreeting().split(' ')[0] }}Ôºå</span>
                  <span class="user-name">{{ getCurrentUser() }}</span>
                  <span class="exclamation">ÔºÅ</span>
                </span>
                <span class="date-section">
                  <el-icon class="calendar-icon"><Calendar /></el-icon>
                  Áé∞Âú®ÊòØ {{ getCurrentDate() }}
                  <el-tag size="small" type="primary" class="weekday-tag">
                    {{ getCurrentWeekday() }}
                  </el-tag>
                </span>
              </p>
            </div>
          </div>
          <div class="header-right">
            <div class="time-filter">
              <span class="filter-label">Êó∂Èó¥ËåÉÂõ¥Ôºö</span>
              <el-select v-model="selectedTimeRange" @change="handleTimeRangeChange" class="time-select">
                <el-option label="‰ªäÂ§©" value="today" />
                <el-option label="Êú¨Âë®" value="week" />
                <el-option label="Êú¨Êúà" value="month" />
                <el-option label="Êú¨Â≠£Â∫¶" value="quarter" />
                <el-option label="Êú¨Âπ¥" value="year" />
              </el-select>
            </div>
            <div class="quick-actions">
              <el-button type="primary" @click="createNewPlan" class="action-btn">
                <el-icon><Plus /></el-icon>
                Êñ∞Âª∫ËÆ°Âàí
              </el-button>
              <el-button @click="refreshData" class="action-btn">
                <el-icon><Refresh /></el-icon>
                Âà∑Êñ∞
              </el-button>
            </div>
          </div>
        </div>
      </div>
    </el-card>
    <el-card class="dashboard-content">
      <el-row :gutter="20">
        <!-- Â∑¶Âç°Áâá -->
        <el-col :span="18">
          <!-- ‰∏äÈÉ®ÂàÜÔºöÁªüËÆ°ÂõæË°®Âç°Áâá -->
          <div class="charts-wrapper">
            <el-card class="charts-card">
              <el-row :gutter="20">
                <!-- Á¨¨‰∏ÄÂàóÔºöÂÆåÊàêÊÉÖÂÜµ -->
                <el-col :span="8">
                  <div class="chart-item completion-chart">
                    <div class="completion-grid">
                      <div class="completion-item">
                        <el-text class="progressbar-title" type="success">ÊÄª‰ΩìÂÆåÊàê</el-text>
                        <div class="completion-progress">
                          <el-progress :percentage="overallProgress" :stroke-width="12" :show-text="false" color="#67C23A" />
                          <el-text class="progressbar-value" type="success">{{ overallProgress }}%</el-text>
                        </div>
                      </div>
                      <div class="completion-item">
                        <el-text class="progressbar-title" type="primary" >Âπ≥ÂùáËøõÂ∫¶</el-text>
                        <div class="completion-progress">
                          <el-progress :percentage="dashboardData.planStats?.avgProgress || 0" :stroke-width="12" :show-text="false" color="#409EFF" />
                          <el-text class="progressbar-value" type="primary">{{ (dashboardData.planStats?.avgProgress || 0).toFixed(1) }}%</el-text>
                        </div>
                      </div>
                      <div class="completion-item">
                        <el-text class="progressbar-title" type="warning">{{ completionRateLabel }}</el-text>
                        <div class="completion-progress">
                          <el-progress :percentage="dashboardData.completionRate || 0" :stroke-width="12" :show-text="false" color="#e6a23c" />
                          <el-text class="progressbar-value" type="warning">{{ dashboardData.completionRate || 0 }}%</el-text>
                        </div>
                      </div>
                      <div class="completion-item">
                        <el-text class="progressbar-title" type="danger">‰ªªÂä°ÊïàÁéá</el-text>
                        <div class="completion-progress">
                          <el-progress :percentage="dashboardData.taskEfficiency || 0" :stroke-width="12" :show-text="false" color="#f56c6c" />
                          <el-tooltip 
                            content="Âü∫‰∫éÊåâÊó∂ÂÆåÊàêÊÉÖÂÜµËØÑÂàÜÔºåÊåâÊó∂ÂÆåÊàêÂæó100ÂàÜÔºåÂª∂ÊúüÂÆåÊàêÊåâÂª∂ÊúüÂ§©Êï∞Êâ£ÂàÜÔºàÊØèÂ§©Êâ£10ÂàÜÔºåÊúÄ‰Ωé0ÂàÜÔºâ" 
                            placement="top"
                            effect="dark"
                          >
                            <el-badge :value="'?'" class="item" type="warning">
                              <el-text class="progressbar-value" type="danger">{{ dashboardData.taskEfficiency || 0 }}&nbsp;ÂàÜ</el-text>
                            </el-badge>
                          </el-tooltip>
                        </div>
                      </div>
                    </div>
                  </div>
                </el-col>

                <!-- Á¨¨‰∫åÂàóÔºöËÆ°ÂàíÁªüËÆ°ÂíåÊü±ÂΩ¢Âõæ -->
                <el-col :span="6">
                  <div class="chart-item bar-chart-item">
                    <div class="middle-content">
                      <!-- ‰∏äÈÉ®ÔºöÁªüËÆ°Ê†áÁ≠æ -->
                      <el-row :gutter="4" justify="center" align="middle" class="stats-tags">
                        <el-col :span="12" class="text-center">
                           <!--<span class="stat-tag stat-tag-total">ÊÄªËÆ°Âàí </span>-->
                          <el-tag class="ml-2" type="info">ÊÄªËÆ°Âàí</el-tag>
                          <el-text class="mx-1" type="info">{{ dashboardData.planStats?.totalPlans || 0 }}È°π</el-text>
                        </el-col>
                        <el-col :span="12" class="text-center">
                          <el-tag class="ml-2" type="success">Â∑≤ÂÆåÊàê </el-tag>
                          <el-text class="mx-1" type="success">{{ dashboardData.planStats?.completedPlans || 0 }}È°π</el-text>
                        </el-col>
                      </el-row>
                      <!-- ‰∏ãÈÉ®ÔºöEChartsÊü±ÂΩ¢Âõæ -->
                      <div class="bar-chart">
                        <div ref="barChartRef" class="echarts-container"></div>
                      </div>
                    </div>
                  </div>
                </el-col>

                <!-- Á¨¨‰∏âÂàóÔºöÂúÜÁéØÂõæ -->
                <el-col :span="10">
                  <div class="chart-item pie-chart-item">
                    <div class="pie-charts">
                      <div class="pie-item">
                        <el-progress
                          type="circle"
                          :percentage="getPercentage('inProgress')"
                          :width="75"
                          :stroke-width="10"
                          color="#409eff"
                        >
                          <template #default="{ percentage }">
                            <div class="pie-center">
                              <el-text class="pie-value" type="primary">{{ percentage }}%</el-text>
                            </div>
                          </template>
                        </el-progress>
                        <el-text class="pie-label" type="primary">ËøõË°å‰∏≠</el-text>
                      </div>
                      <div class="pie-item">
                        <el-progress
                          type="circle"
                          :percentage="getPercentage('completed')"
                          :width="75"
                          :stroke-width="10"
                          color="#67c23a"
                        >
                          <template #default="{ percentage }">
                            <div class="pie-center">
                              <el-text class="pie-value" type="success">{{ percentage }}%</el-text>
                            </div>
                          </template>
                        </el-progress>
                        <el-text class="pie-label" type="success">Â∑≤ÂÆåÊàê</el-text>
                      </div>
                      <div class="pie-item">
                        <el-progress
                          type="circle"
                          :percentage="getPercentage('overdue')"
                          :width="75"
                          :stroke-width="10"
                          color="#f56c6c"
                        >
                          <template #default="{ percentage }">
                            <div class="pie-center">
                              <el-text class="pie-value" type="danger">{{ percentage }}%</el-text>
                            </div>
                          </template>
                        </el-progress>
                        <el-text class="pie-label" type="danger">Â∑≤ÈÄæÊúü</el-text>
                      </div>
                    </div>
                  </div>
                </el-col>
              </el-row>
            </el-card>
          </div>

          <!-- ‰∏ãÈÉ®ÂàÜÔºöÈÄöÁü•ÂÖ¨ÂëäÊ®°Âùó -->

            <el-card class="notice-card">
              <el-row :gutter="8">
                <!-- Â∑¶‰æßÊ†áÈ¢òÂå∫Âüü -->
                <el-col :span="3">
                  <div class="notice-header">
                    <h3 class="notice-title">
                      <el-icon><Bell /></el-icon>
                      <span>ÈÄöÁü•ÂÖ¨Âëä</span>
                    </h3>
                  </div>
                </el-col>
                <!-- Âè≥‰æßÊªöÂä®ÊòæÁ§∫Âå∫Âüü -->
                <el-col :span="21">
                  <div class="notice-content">
                    <div class="notice-scroll" ref="noticeScrollRef">
                      <div 
                        class="notice-item" 
                        v-for="(notice, index) in noticeList" 
                        :key="index"
                        :class="{ 'unread': !notice.IsRead }"
                        @click="viewNoticeFromDashboard(notice)"
                      >
                        <div class="notice-dot" :class="{ 'unread': !notice.IsRead }"></div>
                        <div class="notice-info">
                          <div class="notice-header">
                            <div class="notice-text-wrapper">
                              <div class="notice-text" :class="{ 'unread': !notice.IsRead }">{{ notice.Title }}</div>
                              <el-tag v-if="notice.IsSticky" type="warning" size="small" class="sticky-tag">ÁΩÆÈ°∂</el-tag>
                              <el-tag :type="getNoticeTypeTag(notice.Type)" size="small" class="type-tag">{{ getNoticeTypeLabel(notice.Type) }}</el-tag>
                            </div>
                            <div class="notice-time">{{ formatNoticeTime(notice.PublishDate) }}</div>
                          </div>
                          <div class="notice-content">{{ notice.Content }}</div>
                        </div>
                      </div>
                    </div>
                  </div>
              </el-col>
            </el-row>
          </el-card>
        </el-col>

        <!-- Âè≥Âç°ÁâáÔºöÊó•ÂéÜÁªÑ‰ª∂ -->
        <el-col :span="6">
          <el-card class="calendar-card">
            <div class="calendar-content">
              <el-calendar v-model="currentDate" class="dashboard-calendar">
                <template #date-cell="{ data }">
                  <div class="calendar-day" :class="{ 'is-today': isToday(data.day) }">
                    {{ data.day.split('-').pop() }}
                  </div>
                </template>
              </el-calendar>
            </div>
          </el-card>
        </el-col>
      </el-row>
    </el-card>

    <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
    <el-card class="main-content-card">
      <div class="main-content">
        <div class="content-grid">
          <!-- ÂæÖÂäû‰∫ãÈ°π -->
          <div class="content-section todo-section">
            <div class="section-header">
              <h3 class="section-title">
                <el-icon><Clock /></el-icon>
                ÂæÖÂäû‰∫ãÈ°π
                <el-badge :value="todoList.length" class="todo-badge" />
              </h3>
              <div class="section-actions">
                <el-button text @click="viewAllTodos" class="view-all-btn">
                  Êü•ÁúãÂÖ®ÈÉ®
                  <el-icon class="el-icon--right"><ArrowRight /></el-icon>
                </el-button>
              </div>
            </div>
            <div class="todo-container">
              <div v-if="loading.todos" class="loading-state">
                <el-skeleton :rows="3" animated />
              </div>
              <div v-else-if="displayedTodos.length === 0" class="empty-state">
                <el-empty description="ÊöÇÊó†ÂæÖÂäû‰∫ãÈ°π">
                  <el-button type="primary" @click="createNewPlan">ÂàõÂª∫Êñ∞ËÆ°Âàí</el-button>
                </el-empty>
              </div>
              <ul v-else v-infinite-scroll="loadMoreTodos" :infinite-scroll-disabled="todoLoading || !hasMoreTodos" class="todo-list">
                <li
                  v-for="todo in displayedTodos"
                  :key="todo.ID"
                  class="todo-item"
                  @click="viewPlanDetail(todo.ID)"
                >
                  <span class="todo-priority" :class="`priority-${todo.Priority}`"></span>
                  <div class="todo-main">
                    <div class="todo-header">
                      <el-badge :value="formatUrgency(todo.DaysRemaining)" :type="getUrgencyType(todo.DaysRemaining)" class="title-badge">
                        <h4 class="todo-title">{{ todo.Title }}</h4>
                      </el-badge>
                    </div>
                    <div class="todo-meta">
                      <div class="todo-meta-left">
                        <span class="todo-subtitle">
                          <el-icon><Folder /></el-icon>
                          {{ todo.WorkTypeName }}
                        </span>
                      </div>
                      <div class="todo-meta-center">
                        <span class="todo-deadline">
                          <el-icon><Calendar /></el-icon>
                          <el-text class="mx-1" :type="formatRemainingTime(todo.EndDate) === 'Â∑≤ÈÄæÊúü' ? 'danger' : 'primary'">{{ formatRemainingTime(todo.EndDate) }}</el-text>
                        </span>
                      </div>
                      <div class="todo-meta-right">
                        <el-progress
                          :percentage="todo.Progress"
                          :text-inside="true"
                          :stroke-width="16"
                          :status="getProgressStatus(todo.Progress)"
                          class="todo-progress-bar"
                        />
                      </div>
                    </div>
                  </div>
                </li>
                <li v-if="todoLoading" class="loading-item">
                  <el-skeleton :rows="2" animated />
                </li>
                <li v-if="!hasMoreTodos && displayedTodos.length > 0" class="end-item">
                  <el-divider>Â∑≤ÊòæÁ§∫ÂÖ®ÈÉ®ÂæÖÂäû‰∫ãÈ°π</el-divider>
                </li>
              </ul>
            </div>
          </div>
          
          <!-- ÊúÄËøëÂä®ÊÄÅ -->
          <div class="content-section activity-section">
            <div class="section-header">
              <h3 class="section-title">
                <el-icon><Bell /></el-icon>
                ÊúÄËøëÂä®ÊÄÅ
              </h3>
              <div class="section-actions">
                <el-button text @click="viewAllLogs" class="view-all-btn">
                  Êü•ÁúãÂÖ®ÈÉ®
                  <el-icon class="el-icon--right"><ArrowRight /></el-icon>
                </el-button>
              </div>
            </div>
            <div class="activity-container">
              <div v-if="loading.logs" class="loading-state">
                <el-skeleton :rows="3" animated />
              </div>
              <div v-else-if="recentLogs.length === 0" class="empty-state">
                <el-empty description="ÊöÇÊó†Â∑•‰ΩúËÆ∞ÂΩï">
                  <el-button type="primary" @click="addWorkLog">Ê∑ªÂä†Â∑•‰ΩúËÆ∞ÂΩï</el-button>
                </el-empty>
              </div>
              <div v-else v-infinite-scroll="loadMoreLogs" :infinite-scroll-disabled="timelineLoading || !hasMoreLogs">
                <el-timeline>
                  <el-timeline-item
                    v-for="log in displayedLogs"
                    :key="log.ID"
                    :timestamp="formatLogTime(log.LogDate)"
                    :icon="getTimelineIcon(log)"
                    :type="getTimelineType(log)"
                    :color="getTimelineColor(log)"
                    :size="getTimelineSize(log)"
                    :hollow="getTimelineHollow(log)"
                  >
                    {{ log.PlanTitle || 'Áã¨Á´ãÂ∑•‰ΩúËÆ∞ÂΩï' }} - {{ truncateText(log.Content, 120) }}
                  </el-timeline-item>
                </el-timeline>
                <div v-if="timelineLoading">
                  <el-skeleton :rows="2" animated />
                </div>
                <div v-if="!hasMoreLogs && displayedLogs.length > 0">
                  <el-divider>Â∑≤ÊòæÁ§∫ÂÖ®ÈÉ®ËÆ∞ÂΩï</el-divider>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
  </el-card>
  
  <!-- Êñ∞Â¢ûËÆ°ÂàíÂØπËØùÊ°Ü -->
  <CreatePlanDialog
    v-model="showCreatePlanDialog"
    @success="handlePlanCreateSuccess"
  />
</template>


<script setup>
import { ref, reactive, onMounted, onUnmounted, computed, nextTick } from 'vue'
import { useRouter } from 'vue-router'
import { ElMessage } from 'element-plus'
import { useUserStore } from '@/store/user'
import {
  Sunny,
  Plus,
  EditPen,
  Refresh,
  DataBoard,
  ArrowDown,
  TrendCharts,
  Timer,
  Clock,
  ArrowRight,
  Folder,
  Calendar,
  Bell,
  Check,
  Loading,
  Warning,
  MoreFilled,
  Document,
  QuestionFilled
} from '@element-plus/icons-vue'
import * as echarts from 'echarts'
import api from '@/services/api'
import CreatePlanDialog from '@/components/work-plan/CreatePlanDialog.vue'

// Ë∑ØÁî±ÂÆû‰æã
const router = useRouter()

// Áî®Êà∑Áä∂ÊÄÅÁÆ°ÁêÜ
const userStore = useUserStore()

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const dashboardData = ref({})
const todoList = ref([])
const displayedTodos = ref([]) // ÂæÖÂäû‰∫ãÈ°πÊòæÁ§∫ÁöÑÊï∞ÊçÆ
const recentLogs = ref([])
const displayedLogs = ref([]) // Êó∂Èó¥Á∫øÊòæÁ§∫ÁöÑÊó•Âøó
const selectedTimeRange = ref('month') // ÈªòËÆ§ÈÄâÊã©Êú¨Êúà
const todayWorkHours = ref(8.5)
// const weeklyTargetRate = ref(85) // ÁßªÈô§Á°¨ÁºñÁ†ÅÔºåÊîπ‰∏∫‰ªéAPIËé∑Âèñ
const currentDateTime = ref('') // ÂΩìÂâçÊó•ÊúüÊó∂Èó¥

// Êó†ÈôêÊªöÂä®Áõ∏ÂÖ≥Áä∂ÊÄÅ
const timelineLoading = ref(false)
const hasMoreLogs = ref(true)
const currentPage = ref(1)
const pageSize = ref(10)

// ÂæÖÂäû‰∫ãÈ°πÊó†ÈôêÊªöÂä®Áõ∏ÂÖ≥Áä∂ÊÄÅ
const todoLoading = ref(false)
const hasMoreTodos = ref(true)
const todoCurrentPage = ref(1)
const todoPageSize = ref(10)

// ÂæÖÂäû‰∫ãÈ°πÊ†áÁ≠æÈ°µÁä∂ÊÄÅ
const activeTab = ref('inProgress')

// Êñ∞Â¢ûËÆ°ÂàíÂØπËØùÊ°ÜÁä∂ÊÄÅ
const showCreatePlanDialog = ref(false)

// ÈÄöÁü•ÂÖ¨ÂëäÊï∞ÊçÆ
const noticeList = ref([])

// EChartsÁõ∏ÂÖ≥ÂºïÁî®
const barChartRef = ref(null)
let barChart = null

// ÈÄöÁü•ÊªöÂä®Áõ∏ÂÖ≥ÂºïÁî®
const noticeScrollRef = ref(null)
let noticeScrollTimer = null

// Êó∂Èó¥Êõ¥Êñ∞ÂÆöÊó∂Âô®
let timeUpdateTimer = null

// Áî®‰∫éËß¶ÂèëÂâ©‰ΩôÊó∂Èó¥Êõ¥Êñ∞ÁöÑÂìçÂ∫îÂºèÂèòÈáè
const timeUpdateTrigger = ref(0)

// Êó•ÂéÜÁõ∏ÂÖ≥Êï∞ÊçÆ
const currentDate = ref(new Date())

// Âä†ËΩΩÁä∂ÊÄÅ
const loading = reactive({
  dashboard: false,
  todos: false,
  logs: false
})

// Ê®°Êãü‰∏ÄÂë®ÊïàÁéáÊï∞ÊçÆ
const weeklyEfficiency = ref([
  { day: 'Âë®‰∏Ä', percentage: 85 },
  { day: 'Âë®‰∫å', percentage: 92 },
  { day: 'Âë®‰∏â', percentage: 78 },
  { day: 'Âë®Âõõ', percentage: 95 },
  { day: 'Âë®‰∫î', percentage: 88 },
  { day: 'Âë®ÂÖ≠', percentage: 60 },
  { day: 'Âë®Êó•', percentage: 45 }
])

// ËÆ°ÁÆóÂ±ûÊÄßÔºöÊï¥‰ΩìËøõÂ∫¶
const overallProgress = computed(() => {
  const stats = dashboardData.value.planStats
  if (!stats || !stats.totalPlans) return 0
  return Math.round((stats.completedPlans / stats.totalPlans) * 100)
})

// ËÆ°ÁÆóÂ±ûÊÄßÔºöÂä®ÊÄÅÂÆåÊàêÁéáÊ†áÁ≠æÊñáÊú¨
const completionRateLabel = computed(() => {
  switch (selectedTimeRange.value) {
    case 'today':
      return '‰ªäÊó•ÂÆåÊàê'
    case 'week':
      return 'Êú¨Âë®ÂÆåÊàê'
    case 'month':
      return 'Êú¨ÊúàÂÆåÊàê'
    case 'quarter':
      return 'Êú¨Â≠£ÂÆåÊàê'
    case 'year':
      return 'Êú¨Âπ¥ÂÆåÊàê'
    default:
      return 'Êú¨Âë®ÂÆåÊàê'
  }
})

/**
 * Ëé∑ÂèñÈóÆÂÄôËØ≠
 */
const getGreeting = () => {
  const hour = new Date().getHours()
  const greetings = {
    morning: ['Êó©‰∏äÂ•Ω üåÖ', 'Êñ∞ÁöÑ‰∏ÄÂ§©ÂºÄÂßã‰∫Ü üåû'],
    afternoon: ['‰∏ãÂçàÂ•Ω üå§Ô∏è', '‰∏ãÂçàÊó∂ÂÖâ üåª'],
    evening: ['Êôö‰∏äÂ•Ω üåô', 'Â§úÂπïÈôç‰∏¥ üåÉ']
  }
  
  let timeOfDay, messages
  if (hour >= 5 && hour < 12) {
    timeOfDay = 'morning'
    messages = greetings.morning
  } else if (hour >= 12 && hour < 18) {
    timeOfDay = 'afternoon' 
    messages = greetings.afternoon
  } else {
    timeOfDay = 'evening'
    messages = greetings.evening
  }
  
  // Ê†πÊçÆÊó•ÊúüÈÄâÊã©‰∏çÂêåÁöÑÈóÆÂÄôËØ≠ÔºåËÆ©ÊØèÂ§©ÈÉΩÊúâÊñ∞È≤úÊÑü
  const dayIndex = new Date().getDate() % messages.length
  return messages[dayIndex]
}

/**
 * Ëé∑ÂèñÂΩìÂâçÁî®Êà∑Âêç
 */
const getCurrentUser = () => {
  // ‰ªéÁî®Êà∑Áä∂ÊÄÅÁÆ°ÁêÜ‰∏≠Ëé∑ÂèñÁúüÂÆûÁî®Êà∑‰ø°ÊÅØ
  const user = userStore.user
  if (user && (user.realName || user.RealName)) {
    return user.realName || user.RealName
  }
  if (user && (user.username || user.Username)) {
    return user.username || user.Username
  }
  return 'Áî®Êà∑'
}

/**
 * Êõ¥Êñ∞ÂΩìÂâçÊó•ÊúüÂíåÊó∂Èó¥ÔºàÂåÖÂê´Êó∂ÂàÜÁßíÔºâ
 */
const updateCurrentDateTime = () => {
  const now = new Date()
  const year = now.getFullYear()
  const month = String(now.getMonth() + 1).padStart(2, '0')
  const day = String(now.getDate()).padStart(2, '0')
  const hours = String(now.getHours()).padStart(2, '0')
  const minutes = String(now.getMinutes()).padStart(2, '0')
  const seconds = String(now.getSeconds()).padStart(2, '0')
  
  currentDateTime.value = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`
}

/**
 * Ëé∑ÂèñÂΩìÂâçÊó•ÊúüÂíåÊó∂Èó¥ÔºàÂåÖÂê´Êó∂ÂàÜÁßíÔºâ
 */
const getCurrentDate = () => {
  return currentDateTime.value
}

/**
 * Ëé∑ÂèñÂΩìÂâçÊòüÊúüÂá†
 */
const getCurrentWeekday = () => {
  const today = new Date()
  const options = { 
    weekday: 'long'
  }
  return today.toLocaleDateString('zh-CN', options)
}

/**
 * Ëé∑ÂèñÂ∑•‰ΩúÂè∞Êï∞ÊçÆ
 * @param {string} timeRange - Êó∂Èó¥ËåÉÂõ¥ÂèÇÊï∞ (today, week, month, quarter, year)
 */
const getDashboardData = async (timeRange = null) => {
  try {
    loading.dashboard = true
    const params = {}
    if (timeRange) {
      params.timeRange = timeRange
    }
    const response = await api.get('/work-plan/dashboard', { params })
    if (response.data?.success) {
      dashboardData.value = response.data.data
    }
  } catch (error) {
    console.error('Ëé∑ÂèñÂ∑•‰ΩúÂè∞Êï∞ÊçÆÂ§±Ë¥•:', error)
    // ‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ
    dashboardData.value = {
      planStats: {
        totalPlans: 15,
        inProgressPlans: 6,
        completedPlans: 8,
        overduePlans: 1,
        avgProgress: 78.5,
        weeklyNew: 3,
        upcomingDeadlines: 2
      }
    }
  } finally {
    loading.dashboard = false
  }
}

/**
 * Ëé∑ÂèñÂæÖÂäû‰∫ãÈ°πÂàóË°®ÔºàÂàùÂßãÂä†ËΩΩÔºâ
 * @param {string} timeRange - Êó∂Èó¥ËåÉÂõ¥ÂèÇÊï∞ (today, week, month, quarter, year)
 */
const getTodoList = async (timeRange = null) => {
  try {
    loading.todos = true
    todoCurrentPage.value = 1
    hasMoreTodos.value = true
    const params = {
      page: todoCurrentPage.value,
      limit: todoPageSize.value
    }
    if (timeRange) {
      params.timeRange = timeRange
    }
    const response = await api.get('/work-plan/dashboard/todos', { params })
    if (response.data?.success) {
      todoList.value = response.data.data || []
      displayedTodos.value = [...(response.data.data || [])]
      // Ê£ÄÊü•ÊòØÂê¶ËøòÊúâÊõ¥Â§öÊï∞ÊçÆ
      hasMoreTodos.value = (response.data.data || []).length === todoPageSize.value
    }
  } catch (error) {
    console.error('Ëé∑ÂèñÂæÖÂäû‰∫ãÈ°πÂ§±Ë¥•:', error)
    // ‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ
    const mockTodos = [
      {
        ID: 1,
        Title: 'ÂÆåÊàêÁ≥ªÁªüÊû∂ÊûÑËÆæËÆ°ÊñáÊ°£',
        Priority: 'high',
        WorkTypeName: 'Á≥ªÁªüËÆæËÆ°',
        EndDate: '2024-01-25',
        DaysRemaining: 2,
        Progress: 75
      },
      {
        ID: 2,
        Title: 'Áî®Êà∑ÁïåÈù¢ÂéüÂûãËÆæËÆ°',
        Priority: 'medium',
        WorkTypeName: 'UIËÆæËÆ°',
        EndDate: '2024-01-28',
        DaysRemaining: 5,
        Progress: 45
      },
      {
        ID: 3,
        Title: 'Êï∞ÊçÆÂ∫ìÊÄßËÉΩ‰ºòÂåñ',
        Priority: 'high',
        WorkTypeName: 'Êï∞ÊçÆÂ∫ì',
        EndDate: '2024-01-22',
        DaysRemaining: -1,
        Progress: 90
      },
      {
        ID: 4,
        Title: 'ÂâçÁ´ØÁªÑ‰ª∂ÂºÄÂèë',
        Priority: 'medium',
        WorkTypeName: 'ÂâçÁ´ØÂºÄÂèë',
        EndDate: '2024-01-30',
        DaysRemaining: 7,
        Progress: 30
      },
      {
        ID: 5,
        Title: 'Êé•Âè£ÊñáÊ°£ÁºñÂÜô',
        Priority: 'low',
        WorkTypeName: 'ÊñáÊ°£',
        EndDate: '2024-02-01',
        DaysRemaining: 9,
        Progress: 15
      },
      {
        ID: 6,
        Title: 'ÂçïÂÖÉÊµãËØïÁºñÂÜô',
        Priority: 'high',
        WorkTypeName: 'ÊµãËØï',
        EndDate: '2024-01-26',
        DaysRemaining: 3,
        Progress: 60
      },
      {
        ID: 7,
        Title: '‰ª£Á†ÅÂÆ°Êü•',
        Priority: 'medium',
        WorkTypeName: '‰ª£Á†ÅË¥®Èáè',
        EndDate: '2024-01-29',
        DaysRemaining: 6,
        Progress: 80
      },
      {
        ID: 8,
        Title: 'ÈÉ®ÁΩ≤ËÑöÊú¨‰ºòÂåñ',
        Priority: 'low',
        WorkTypeName: 'ËøêÁª¥',
        EndDate: '2024-02-05',
        DaysRemaining: 13,
        Progress: 25
      }
    ]
    todoList.value = mockTodos
    displayedTodos.value = mockTodos.slice(0, todoPageSize.value)
    hasMoreTodos.value = mockTodos.length > todoPageSize.value
  } finally {
    loading.todos = false
  }
}

/**
 * Âä†ËΩΩÊõ¥Â§öÂæÖÂäû‰∫ãÈ°πÔºàÊó†ÈôêÊªöÂä®Ôºâ
 */
const loadMoreTodos = async () => {
  if (todoLoading.value || !hasMoreTodos.value) return
  
  try {
    todoLoading.value = true
    todoCurrentPage.value++
    
    const params = {
      page: todoCurrentPage.value,
      limit: todoPageSize.value
    }
    
    const response = await api.get('/work-plan/dashboard/todos', { params })
    
    if (response.success) {
      const newTodos = response.data
      todoList.value = [...todoList.value, ...newTodos]
      displayedTodos.value = [...displayedTodos.value, ...newTodos]
      // Ê£ÄÊü•ÊòØÂê¶ËøòÊúâÊõ¥Â§öÊï∞ÊçÆ
      hasMoreTodos.value = newTodos.length === todoPageSize.value
    }
  } catch (error) {
    console.error('Âä†ËΩΩÊõ¥Â§öÂæÖÂäû‰∫ãÈ°πÂ§±Ë¥•:', error)
    // Ê®°ÊãüÂä†ËΩΩÊõ¥Â§öÊï∞ÊçÆ
    const startIndex = (todoCurrentPage.value - 1) * todoPageSize.value
    const endIndex = startIndex + todoPageSize.value
    const allMockTodos = todoList.value
    
    if (startIndex < allMockTodos.length) {
      const newTodos = allMockTodos.slice(startIndex, endIndex)
      displayedTodos.value = [...displayedTodos.value, ...newTodos]
      hasMoreTodos.value = endIndex < allMockTodos.length
    } else {
      hasMoreTodos.value = false
    }
  } finally {
    todoLoading.value = false
  }
}

/**
 * Ëé∑ÂèñÊúÄËøëÂ∑•‰ΩúÊó•Âøó
 * @param {string} timeRange - Êó∂Èó¥ËåÉÂõ¥ÂèÇÊï∞ (today, week, month, quarter, year)
 */
const getRecentLogs = async (timeRange = null) => {
  try {
    loading.logs = true
    currentPage.value = 1
    hasMoreLogs.value = true
    const params = {
      page: currentPage.value,
      limit: pageSize.value
    }
    if (timeRange) {
      params.timeRange = timeRange
    }
    const response = await api.get('/work-plan/dashboard/recent-logs', { params })
    if (response.success) {
      recentLogs.value = response.data.data || []
      displayedLogs.value = [...(response.data.data || [])]
      // Ê£ÄÊü•ÊòØÂê¶ËøòÊúâÊõ¥Â§öÊï∞ÊçÆ
      hasMoreLogs.value = (response.data.data || []).length === pageSize.value
    }
  } catch (error) {
    console.error('Ëé∑ÂèñÊúÄËøëÂ∑•‰ΩúÊó•ÂøóÂ§±Ë¥•:', error)
    // ‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ
    const mockData = [
      {
        ID: 1,
        PlanTitle: 'Á≥ªÁªüÊû∂ÊûÑËÆæËÆ°',
        Content: 'ÂÆåÊàê‰∫ÜÊ†∏ÂøÉÊ®°ÂùóÁöÑÊû∂ÊûÑËÆæËÆ°ÔºåÂåÖÊã¨Áî®Êà∑ÁÆ°ÁêÜ„ÄÅÊùÉÈôêÊéßÂà∂ÂíåÊï∞ÊçÆÊµÅËÆæËÆ°',
        LogDate: '2024-01-20 14:30:00',
        WorkHours: 4,
        Progress: 75
      },
      {
        ID: 2,
        PlanTitle: 'UIÁïåÈù¢ËÆæËÆ°',
        Content: 'ËÆæËÆ°‰∫Ü‰∏ªË¶ÅÈ°µÈù¢ÁöÑ‰∫§‰∫íÂéüÂûãÔºåÂåÖÊã¨ÁôªÂΩïÈ°µÈù¢„ÄÅ‰ª™Ë°®ÁõòÂíåÁî®Êà∑ÁÆ°ÁêÜÈ°µÈù¢',
        LogDate: '2024-01-20 10:15:00',
        WorkHours: 3,
        Progress: 45
      },
      {
        ID: 3,
        PlanTitle: 'Êï∞ÊçÆÂ∫ìËÆæËÆ°',
        Content: 'ÂÆåÊàê‰∫ÜÁî®Êà∑Ë°®„ÄÅÊùÉÈôêË°®ÂíåÂ∑•‰ΩúËÆ°ÂàíË°®ÁöÑËÆæËÆ°ÔºåÂª∫Á´ã‰∫ÜÂÆåÊï¥ÁöÑÊï∞ÊçÆÂÖ≥Á≥ª',
        LogDate: '2024-01-19 16:20:00',
        WorkHours: 5,
        Progress: 90
      },
      {
        ID: 4,
        PlanTitle: 'Êé•Âè£ÂºÄÂèë',
        Content: 'ÂºÄÂèë‰∫ÜÁî®Êà∑ËÆ§ËØÅ„ÄÅÊùÉÈôêÈ™åËØÅÂíåÂü∫Á°ÄCRUDÊé•Âè£',
        LogDate: '2024-01-19 11:45:00',
        WorkHours: 6,
        Progress: 60
      },
      {
        ID: 5,
        PlanTitle: 'ÂâçÁ´ØÁªÑ‰ª∂ÂºÄÂèë',
        Content: 'ÂÆåÊàê‰∫ÜÈÄöÁî®Ë°®Ê†ºÁªÑ‰ª∂„ÄÅË°®ÂçïÁªÑ‰ª∂ÂíåÂºπÁ™óÁªÑ‰ª∂ÁöÑÂºÄÂèë',
        LogDate: '2024-01-18 15:30:00',
        WorkHours: 4,
        Progress: 80
      }
    ]
    recentLogs.value = mockData
    displayedLogs.value = [...mockData]
    hasMoreLogs.value = false
  } finally {
    loading.logs = false
  }
}

/**
 * Ëé∑ÂèñÈÄöÁü•ÂÖ¨ÂëäÂàóË°®
 * @param {string} timeRange - Êó∂Èó¥ËåÉÂõ¥ÂèÇÊï∞ (today, week, month, quarter, year)
 */
const getNoticeList = async (timeRange = null) => {
  try {
    const params = {
      page: 1,
      size: 5, // ÈôêÂà∂ÊòæÁ§∫5Êù°
      readStatus: '' // ÊòæÁ§∫ÊâÄÊúâÈÄöÁü•
    }
    if (timeRange) {
      params.timeRange = timeRange
    }
    const response = await api.get('/notice', { params })
    if (response.success) {
      // ÂêéÁ´ØËøîÂõûÁöÑÊï∞ÊçÆÁªìÊûÑÊòØ { success: true, data: {...}, message: '...' }
      // ÈúÄË¶Å‰ªé response.data.data Ëé∑ÂèñÂÆûÈôÖÊï∞ÊçÆ
      noticeList.value = response.data.data || []
    }
  } catch (error) {
    console.error('Ëé∑ÂèñÈÄöÁü•ÂÖ¨ÂëäÂ§±Ë¥•:', error)
    // ‰øùÊåÅÁ©∫Êï∞ÁªÑÔºå‰∏ç‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ
    noticeList.value = []
  }
}

/**
 * Ëé∑ÂèñÊú™ËØªÈÄöÁü•Êï∞Èáè
 */
const getUnreadNoticeCount = async () => {
  try {
    const response = await api.get('/notice/unread/count')
    if (response.success) {
      // ËøôÈáåÂèØ‰ª•Áî®‰∫éÊõ¥Êñ∞ÂÖ®Â±ÄÊú™ËØªÊï∞ÈáèÁä∂ÊÄÅ
      return response.data || 0
    }
  } catch (error) {
    console.error('Ëé∑ÂèñÊú™ËØªÈÄöÁü•Êï∞ÈáèÂ§±Ë¥•:', error)
    return 0
  }
}

/**
 * Êü•ÁúãÈÄöÁü•ËØ¶ÊÉÖÔºà‰ªéÂ∑•‰ΩúÂè∞Ôºâ
 * @param {Object} notice - ÈÄöÁü•ÂØπË±°
 */
const viewNoticeFromDashboard = async (notice) => {
  try {
    // Â¶ÇÊûúÊòØÊú™ËØªÈÄöÁü•ÔºåÂÖàÊ†áËÆ∞‰∏∫Â∑≤ËØª
    if (!notice.IsRead) {
      await api.post(`/notice/${notice.ID}/read`)
      // Êõ¥Êñ∞Êú¨Âú∞Áä∂ÊÄÅ
      notice.IsRead = true
    }
    
    // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†ÊòæÁ§∫ÈÄöÁü•ËØ¶ÊÉÖÁöÑÈÄªËæë
    // ÊàñËÄÖË∑≥ËΩ¨Âà∞ÈÄöÁü•ÁÆ°ÁêÜÈ°µÈù¢
    ElMessage({
      message: `Êü•ÁúãÈÄöÁü•Ôºö${notice.Title}`,
      type: 'info',
      duration: 2000
    })
  } catch (error) {
    console.error('Êü•ÁúãÈÄöÁü•Â§±Ë¥•:', error)
    ElMessage.error('Êü•ÁúãÈÄöÁü•Â§±Ë¥•')
  }
}

/**
 * Ëé∑ÂèñÈÄöÁü•Á±ªÂûãÊ†áÁ≠æÊ†∑Âºè
 * @param {string} type - ÈÄöÁü•Á±ªÂûã
 * @returns {string} Ê†áÁ≠æÁ±ªÂûã
 */
const getNoticeTypeTag = (type) => {
  const typeMap = {
    'system': 'info',
    'announcement': 'success', 
    'urgent': 'danger',
    'maintenance': 'warning'
  }
  return typeMap[type] || 'info'
}

/**
 * Ëé∑ÂèñÈÄöÁü•Á±ªÂûãÊ†áÁ≠æÊñáÊú¨
 * @param {string} type - ÈÄöÁü•Á±ªÂûã
 * @returns {string} Ê†áÁ≠æÊñáÊú¨
 */
const getNoticeTypeLabel = (type) => {
  const labelMap = {
    'system': 'Á≥ªÁªü',
    'announcement': 'ÂÖ¨Âëä',
    'urgent': 'Á¥ßÊÄ•',
    'maintenance': 'Áª¥Êä§'
  }
  return labelMap[type] || 'ÈÄöÁü•'
}

/**
 * Ê†ºÂºèÂåñÈÄöÁü•Êó∂Èó¥
 * @param {string} dateStr - Êó•ÊúüÂ≠óÁ¨¶‰∏≤
 * @returns {string} Ê†ºÂºèÂåñÂêéÁöÑÊó∂Èó¥
 */
const formatNoticeTime = (dateStr) => {
  if (!dateStr) return ''
  
  const date = new Date(dateStr)
  const now = new Date()
  const diff = now - date
  
  // Â∞è‰∫é1ÂàÜÈíü
  if (diff < 60000) {
    return 'ÂàöÂàö'
  }
  // Â∞è‰∫é1Â∞èÊó∂
  if (diff < 3600000) {
    return `${Math.floor(diff / 60000)}ÂàÜÈíüÂâç`
  }
  // Â∞è‰∫é1Â§©
  if (diff < 86400000) {
    return `${Math.floor(diff / 3600000)}Â∞èÊó∂Ââç`
  }
  // Â∞è‰∫é7Â§©
  if (diff < 604800000) {
    return `${Math.floor(diff / 86400000)}Â§©Ââç`
  }
  // Ë∂ÖËøá7Â§©ÊòæÁ§∫ÂÖ∑‰ΩìÊó•Êúü
  return date.toLocaleDateString('zh-CN', {
    month: '2-digit',
    day: '2-digit'
  })
}

/**
 * ÂàùÂßãÂåñEChartsÊü±Áä∂Âõæ
 */
const initBarChart = () => {
  if (!barChartRef.value) return
  
  // ÈîÄÊØÅÂ∑≤Â≠òÂú®ÁöÑÂõæË°®ÂÆû‰æã
  if (barChart) {
    barChart.dispose()
  }
  
  // ÂàõÂª∫Êñ∞ÁöÑÂõæË°®ÂÆû‰æã
  barChart = echarts.init(barChartRef.value)
  
  // Êõ¥Êñ∞ÂõæË°®Êï∞ÊçÆ
  updateBarChart()
}

/**
 * Êõ¥Êñ∞EChartsÊü±Áä∂ÂõæÊï∞ÊçÆ
 */
const updateBarChart = () => {
  // ‰∏•Ê†ºÁöÑÊï∞ÊçÆÈ™åËØÅ
  if (!barChart) {
    return   // barChartÂÆû‰æã‰∏çÂ≠òÂú®ÔºåË∑≥ËøáÊõ¥Êñ∞
  }
  
  if (!dashboardData.value || !dashboardData.value.planStats) {
    return  // dashboardData.planStats‰∏çÂ≠òÂú®ÔºåË∑≥ËøáÂõæË°®Êõ¥Êñ∞
  }
  
  const stats = dashboardData.value.planStats
  
  // Á°Æ‰øùÊâÄÊúâÊï∞ÂÄºÈÉΩÊòØÊúâÊïàÁöÑÊï∞Â≠ó
  const safeValue = (val) => {
    const num = Number(val)
    return isNaN(num) ? 0 : num
  }
  
  const data = [
    {
      name: 'ËøõË°å‰∏≠',
      value: safeValue(stats.inProgressPlans),
      itemStyle: {
        color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
          { offset: 0, color: '#4A90E2' },
          { offset: 1, color: '#8EC1F7' }
        ])
      }
    },
    {
       name: 'Â∑≤ÂÆåÊàê',
       value: safeValue(stats.completedPlans),
       itemStyle: {
         color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
           { offset: 0, color: '#67C23A' },
           { offset: 1, color: '#95D475' }
         ])
       }
     },
    {
      name: 'Â∑≤ÈÄæÊúü',
      value: safeValue(stats.overduePlans),
      itemStyle: {
        color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
          { offset: 0, color: '#D0021B' },
          { offset: 1, color: '#F78B9B' }
        ])
      }
    }
  ]
  
  // È™åËØÅÊï∞ÊçÆÂÆåÊï¥ÊÄß
  const hasValidData = data.every(item => 
    item.name && 
    typeof item.value === 'number' && 
    !isNaN(item.value) &&
    item.itemStyle
  )
  
  if (!hasValidData) {
    console.error('‚ùå EChartsÊï∞ÊçÆÈ™åËØÅÂ§±Ë¥•ÔºåË∑≥ËøáÊõ¥Êñ∞')
    return
  }
  
  try {
    const option = {
      grid: {
        left: '0%',
        right: '0%',
        top: '20%',
        bottom: '25%'
      },
      xAxis: {
        type: 'category',
        data: data.map(item => item.name),
        axisLine: {
          show: true,
          lineStyle: {
            color: '#e0e0e0'
          }
        },
        axisTick: {
          show: false
        },
        axisLabel: {
          color: '#666',
          fontSize: 12
        },
        splitLine: {
          show: true,
          lineStyle: {
            color: '#e0e0e0',
            type: 'dashed',
            width: 1
          }
        }
      },
      yAxis: {
        type: 'value',
        show: true,
        axisLine: {
          show: false
        },
        axisTick: {
          show: false
        },
        axisLabel: {
          show: false
        },
        splitLine: {
          show: false
        }
      },
      series: [{
        type: 'bar',
        data: data,
        barWidth: '40%',
        label: {
          show: true,
          position: 'top',
          formatter: '{c}È°π',
          color: '#333',
          fontFamily: 'Microsoft YaHei, Arial, sans-serif',
          fontSize: 12,
          fontWeight: 'normal'
        },
        emphasis: {
          itemStyle: {
            shadowBlur: 10,
            shadowColor: 'rgba(0, 0, 0, 0.3)'
          }
        }
      }]
    }
    
    barChart.setOption(option, true) // ‰ΩøÁî®notMerge=trueÁ°Æ‰øùÂÆåÂÖ®ÊõøÊç¢
    console.log('‚úÖ EChartsÂõæË°®Êõ¥Êñ∞ÊàêÂäü')
  } catch (error) {
    console.error('‚ùå ECharts setOptionÂ§±Ë¥•:', error)
  }
}

/**
 * Âà∑Êñ∞ÊâÄÊúâÊï∞ÊçÆ
 */
const refreshData = async () => {
  // Ëé∑ÂèñÂΩìÂâçÈÄâÊã©ÁöÑÊó∂Èó¥ËåÉÂõ¥
  const timeRange = selectedTimeRange.value || null
  
  await Promise.all([
    getDashboardData(timeRange),
    getTodoList(timeRange),
    getRecentLogs(timeRange),
    getNoticeList(timeRange)
  ])
  
  // Êï∞ÊçÆÊõ¥Êñ∞ÂêéÂà∑Êñ∞ÂõæË°®
  await nextTick()
  updateBarChart()
}

/**
 * Â§ÑÁêÜÊó∂Èó¥ËåÉÂõ¥ÂèòÂåñ
 */
const handleTimeRangeChange = (value) => {
  selectedTimeRange.value = value
  // Ê†πÊçÆÊó∂Èó¥ËåÉÂõ¥ÈáçÊñ∞Ëé∑ÂèñÊï∞ÊçÆ
  refreshDataByTimeRange()
}

/**
 * Ê†πÊçÆÊó∂Èó¥ËåÉÂõ¥Âà∑Êñ∞Êï∞ÊçÆ
 */
const refreshDataByTimeRange = async () => {
  try {
    loading.dashboard = true
    // Ê†πÊçÆselectedTimeRange.valueË∞ÉÁî®APIÂπ∂‰º†ÈÄíÊó∂Èó¥ËåÉÂõ¥ÂèÇÊï∞
    const timeRange = selectedTimeRange.value || null
    await Promise.all([
      getDashboardData(timeRange),
      getTodoList(timeRange),
      getRecentLogs(timeRange),
      getNoticeList(timeRange)
    ])
    
    // Êï∞ÊçÆÊõ¥Êñ∞ÂêéÂà∑Êñ∞ÂõæË°®
    await nextTick()
    updateBarChart()
  } catch (error) {
    console.error('Âà∑Êñ∞Êï∞ÊçÆÂ§±Ë¥•:', error)
  } finally {
    loading.dashboard = false
  }
}



/**
 * ËÆ°ÁÆóÂúÜÁéØÂõæÁôæÂàÜÊØî
 */
const getPercentage = (type) => {
  const stats = dashboardData.value.planStats
  if (!stats || !stats.totalPlans) return 0
  
  let value = 0
  switch (type) {
    case 'inProgress':
      value = stats.inProgressPlans || 0
      break
    case 'completed':
      value = stats.completedPlans || 0
      break
    case 'overdue':
      value = stats.overduePlans || 0
      break
  }
  
  return Math.round((value / stats.totalPlans) * 100)
}

/**
 * Ëé∑ÂèñËøõÂ∫¶Êù°Ê∏êÂèòËâ≤
 */
const getProgressColorGradient = (percentage) => {
  if (percentage >= 80) {
    return [{ color: '#67c23a', percentage: 100 }]
  } else if (percentage >= 60) {
    return [{ color: '#e6a23c', percentage: 100 }]
  } else if (percentage >= 40) {
    return [{ color: '#f56c6c', percentage: 100 }]
  } else {
    return [{ color: '#909399', percentage: 100 }]
  }
}

/**
 * Ëé∑ÂèñËøõÂ∫¶Êù°Áä∂ÊÄÅ
 * @param {number} percentage - ËøõÂ∫¶ÁôæÂàÜÊØî
 * @returns {string} ËøõÂ∫¶Êù°Áä∂ÊÄÅ
 */
const getProgressStatus = (percentage) => {
  if (percentage === 100) {
    return 'success'
  } else if (percentage >= 80) {
    return 'warning'
  } else if (percentage >= 50) {
    return undefined // ÈªòËÆ§Áä∂ÊÄÅ
  } else {
    return 'exception'
  }
}

/**
 * Ê†ºÂºèÂåñÁ¥ßÊÄ•Á®ãÂ∫¶
 */
const formatUrgency = (daysRemaining) => {
  if (daysRemaining < 0) return 'Â∑≤ÈÄæÊúü'
  if (daysRemaining === 0) return '‰ªäÂ§©Âà∞Êúü'
  if (daysRemaining <= 3) return 'Á¥ßÊÄ•'
  if (daysRemaining <= 7) return 'Âç≥Â∞ÜÂà∞Êúü'
  return 'Ê≠£Â∏∏'
}

/**
 * Ëé∑ÂèñÁ¥ßÊÄ•Á®ãÂ∫¶Á±ªÂûã
 */
const getUrgencyType = (daysRemaining) => {
  if (daysRemaining < 0) return 'danger'
  if (daysRemaining <= 3) return 'warning'
  return 'info'
}

/**
 * Ê†ºÂºèÂåñÊó•Êúü
 */
const formatDate = (dateStr) => {
  const date = new Date(dateStr)
  return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' })
}

/**
 * ËÆ°ÁÆóÂπ∂Ê†ºÂºèÂåñÂâ©‰ΩôÊó∂Èó¥
 * @param {string} endDateStr - ÁªìÊùüÊó•ÊúüÂ≠óÁ¨¶‰∏≤
 * @returns {string} Ê†ºÂºèÂåñÁöÑÂâ©‰ΩôÊó∂Èó¥Â≠óÁ¨¶‰∏≤
 */
const formatRemainingTime = (endDateStr) => {
  // ‰æùËµñtimeUpdateTriggerÊù•Ëß¶ÂèëÈáçÊñ∞ËÆ°ÁÆó
  timeUpdateTrigger.value
  
  if (!endDateStr) return 'Êó†Êà™Ê≠¢Êó∂Èó¥'
  
  // Â∞ÜdateÁ±ªÂûãÁöÑÊà™Ê≠¢Êó•ÊúüËÆæÁΩÆ‰∏∫ÂΩìÂ§©ÁöÑ23:59:59
  const endDate = new Date(endDateStr)
  endDate.setHours(23, 59, 59, 999)
  
  const now = new Date()
  const timeDiff = endDate.getTime() - now.getTime()
  
  // Â¶ÇÊûúÂ∑≤ÁªèËøáÊúü
  if (timeDiff <= 0) {
    return 'Â∑≤ÈÄæÊúü'
  }
  
  // ËÆ°ÁÆóÂâ©‰ΩôÁöÑÂ§©„ÄÅÂ∞èÊó∂„ÄÅÂàÜÈíü„ÄÅÁßí
  const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24))
  const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))
  const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60))
  const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000)
  
  // Ê†ºÂºèÂåñÊó∂Èó¥ÊòæÁ§∫
  if (days > 0) {
    return `ËøòÂâ©‰Ωô ${days}Â§© ${hours.toString().padStart(2, '0')}Êó∂${minutes.toString().padStart(2, '0')}ÂàÜ${seconds.toString().padStart(2, '0')}Áßí`
  } else {
    return `ËøòÂâ©‰Ωô ${hours.toString().padStart(2, '0')}Êó∂${minutes.toString().padStart(2, '0')}ÂàÜ${seconds.toString().padStart(2, '0')}Áßí`
  }
}

/**
 * Ê†ºÂºèÂåñÊó∂Èó¥Ë∑ùÁ¶ª
 */
const formatTimeAgo = (dateStr) => {
  const date = new Date(dateStr)
  const now = new Date()
  const diff = now - date
  const hours = Math.floor(diff / (1000 * 60 * 60))
  const days = Math.floor(hours / 24)
  
  if (days > 0) return `${days}Â§©Ââç`
  if (hours > 0) return `${hours}Â∞èÊó∂Ââç`
  return 'ÂàöÂàö'
}

/**
 * Âà§Êñ≠ÊòØÂê¶‰∏∫‰ªäÂ§©
 */
const isToday = (dateStr) => {
  const today = new Date()
  const date = new Date(dateStr)
  return today.toDateString() === date.toDateString()
}

/**
 * Ëé∑ÂèñÊ¥ªÂä®Á±ªÂûã
 */
const getActivityType = (log) => {
  if (log.Progress >= 100) return 'completed'
  if (log.Issues) return 'warning'
  return 'normal'
}

/**
 * Êó†ÈôêÊªöÂä®Âä†ËΩΩÊõ¥Â§öÊó•Âøó
 */
const loadMoreLogs = async () => {
  if (timelineLoading.value || !hasMoreLogs.value) return
  
  try {
    timelineLoading.value = true
    currentPage.value++
    
    const params = {
      page: currentPage.value,
      limit: pageSize.value
    }
    
    // Ê∑ªÂä†Êó∂Èó¥ËåÉÂõ¥ÂèÇÊï∞
    const timeRange = selectedTimeRange.value || null
    if (timeRange) {
      params.timeRange = timeRange
    }
    
    const response = await api.get('/work-plan/dashboard/recent-logs', { params })
    
    if (response.success && response.data.length > 0) {
      displayedLogs.value.push(...response.data)
      hasMoreLogs.value = response.data.length === pageSize.value
    } else {
      hasMoreLogs.value = false
    }
  } catch (error) {
    console.error('Âä†ËΩΩÊõ¥Â§öÊó•ÂøóÂ§±Ë¥•:', error)
    hasMoreLogs.value = false
  } finally {
    timelineLoading.value = false
  }
}

/**
 * Ê†ºÂºèÂåñÊó•ÂøóÊó∂Èó¥Áî®‰∫éÊó∂Èó¥Á∫øÊòæÁ§∫
 */
const formatLogTime = (dateStr) => {
  const date = new Date(dateStr)
  const now = new Date()
  const diffTime = now - date
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24))
  
  if (diffDays === 0) {
    return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
  } else if (diffDays === 1) {
    return 'Êò®Â§© ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
  } else if (diffDays < 7) {
    return `${diffDays}Â§©Ââç`
  } else {
    return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' })
  }
}





/**
 * Ëé∑ÂèñËøõÂ∫¶Ê†áÁ≠æÁ±ªÂûã
 */
const getProgressTagType = (progress) => {
  if (progress >= 100) return 'success'
  if (progress >= 80) return 'primary'
  if (progress >= 60) return 'warning'
  if (progress >= 40) return 'danger'
  return 'info'
}

/**
 * Ëé∑ÂèñËøõÂ∫¶Ê†∑ÂºèÁ±ª
 * @param {number} progress - ËøõÂ∫¶ÁôæÂàÜÊØî
 * @returns {string} CSSÁ±ªÂêç
 */
const getProgressClass = (progress) => {
  if (progress >= 90) return 'progress-success'
  if (progress >= 70) return 'progress-warning'
  if (progress >= 50) return 'progress-info'
  return 'progress-danger'
}

/**
 * Ëé∑ÂèñËøõÂ∫¶È¢úËâ≤
 * @param {number} progress - ËøõÂ∫¶ÁôæÂàÜÊØî
 * @returns {string} È¢úËâ≤ÂÄº
 */
const getProgressColor = (progress) => {
  if (progress >= 90) return '#67c23a'
  if (progress >= 70) return '#e6a23c'
  if (progress >= 50) return '#409eff'
  return '#f56c6c'
}

/**
 * Ëé∑ÂèñÊ†áÁ≠æÈ°µËÆ°Êï∞
 * @param {string} tabName - Ê†áÁ≠æÈ°µÂêçÁß∞
 * @returns {number} ËØ•Ê†áÁ≠æÈ°µÁöÑÂæÖÂäû‰∫ãÈ°πÊï∞Èáè
 */
const getTabCount = (tabName) => {
  return getFilteredTodos(tabName).length
}

/**
 * Ê†πÊçÆÊ†áÁ≠æÈ°µËøáÊª§ÂæÖÂäû‰∫ãÈ°π
 * @param {string} tabName - Ê†áÁ≠æÈ°µÂêçÁß∞
 * @returns {Array} ËøáÊª§ÂêéÁöÑÂæÖÂäû‰∫ãÈ°πÂàóË°®
 */
const getFilteredTodos = (tabName) => {
  switch (tabName) {
    case 'inProgress':
      return todoList.value.filter(todo => todo.Progress > 0 && todo.Progress < 100)
    case 'completed':
      return todoList.value.filter(todo => todo.Progress >= 100)
    case 'pending':
      return todoList.value.filter(todo => todo.Progress === 0)
    default:
      return todoList.value
  }
}

/**
 * Ëé∑ÂèñÊó∂Èó¥Á∫øÂõæÊ†á
 * @param {Object} log - Â∑•‰ΩúÊó•ÂøóÂØπË±°
 * @returns {Component} ÂõæÊ†áÁªÑ‰ª∂
 */
const getTimelineIcon = (log) => {
  // Ê†πÊçÆÂ∑•‰ΩúÊó∂ÈïøÊàñËøõÂ∫¶ËøîÂõû‰∏çÂêåÂõæÊ†á
  if (log.WorkHours >= 8) return MoreFilled
  if (log.Progress >= 80) return Check
  if (log.Progress >= 50) return Clock
  return Document
}

/**
 * Ëé∑ÂèñÊó∂Èó¥Á∫øÁ±ªÂûã
 * @param {Object} log - Â∑•‰ΩúÊó•ÂøóÂØπË±°
 * @returns {string} Êó∂Èó¥Á∫øÁ±ªÂûã
 */
const getTimelineType = (log) => {
  if (log.Progress >= 80) return 'success'
  if (log.Progress >= 60) return 'warning'
  if (log.Progress >= 40) return 'primary'
  return 'info'
}

/**
 * Ëé∑ÂèñÊó∂Èó¥Á∫øÈ¢úËâ≤
 * @param {Object} log - Â∑•‰ΩúÊó•ÂøóÂØπË±°
 * @returns {string} Êó∂Èó¥Á∫øËäÇÁÇπÈ¢úËâ≤
 */
const getTimelineColor = (log) => {
  // Ê†πÊçÆËøõÂ∫¶ËøîÂõû‰∏çÂêåÈ¢úËâ≤
  if (log.Progress >= 100) return '#67c23a' // ÁªøËâ≤ - Â∑≤ÂÆåÊàê
  if (log.Progress >= 80) return '#409eff' // ËìùËâ≤ - ËøõÂ±ïËâØÂ•Ω
  if (log.Progress >= 60) return '#e6a23c' // Ê©ôËâ≤ - ËøõÂ±ï‰∏≠
  if (log.Progress >= 40) return '#f56c6c' // Á∫¢Ëâ≤ - ÈúÄÂÖ≥Ê≥®
  if (log.WorkHours >= 8) return '#0bbd87' // ÈùíËâ≤ - È´òÂ∑•Êó∂
  return '#909399' // ÁÅ∞Ëâ≤ - ÂàöÂºÄÂßã
}

/**
 * Ëé∑ÂèñÊó∂Èó¥Á∫øÂ§ßÂ∞è
 * @param {Object} log - Â∑•‰ΩúÊó•ÂøóÂØπË±°
 * @returns {string} Êó∂Èó¥Á∫øËäÇÁÇπÂ§ßÂ∞è
 */
const getTimelineSize = (log) => {
  // ÈáçË¶ÅËÆ∞ÂΩï‰ΩøÁî®Â§ßÂ∞∫ÂØ∏
  if (log.WorkHours >= 8 || log.Progress >= 80) return 'large'
  return 'normal'
}

/**
 * Ëé∑ÂèñÊó∂Èó¥Á∫øÁ©∫ÂøÉÊ†∑Âºè
 * @param {Object} log - Â∑•‰ΩúÊó•ÂøóÂØπË±°
 * @returns {boolean} ÊòØÂê¶‰ΩøÁî®Á©∫ÂøÉÊ†∑Âºè
 */
const getTimelineHollow = (log) => {
  // ËøõË°å‰∏≠ÁöÑ‰ªªÂä°‰ΩøÁî®Á©∫ÂøÉÊ†∑Âºè
  return log.Progress > 0 && log.Progress < 100
}

/**
 * Êà™Êñ≠ÊñáÊú¨
 */
const truncateText = (text, maxLength) => {
  if (!text) return ''
  return text.length > maxLength ? text.substring(0, maxLength) + '...' : text
}

/**
 * ÂàõÂª∫Êñ∞ËÆ°Âàí
 */
const createNewPlan = () => {
  showCreatePlanDialog.value = true
}

/**
 * Â§ÑÁêÜËÆ°ÂàíÂàõÂª∫ÊàêÂäü
 */
const handlePlanCreateSuccess = () => {
  // Âà∑Êñ∞Â∑•‰ΩúÂè∞Êï∞ÊçÆ
  refreshData()
  ElMessage.success('ËÆ°ÂàíÂàõÂª∫ÊàêÂäüÔºÅ')
}

/**
 * Ê∑ªÂä†Â∑•‰ΩúËÆ∞ÂΩï
 */
const addWorkLog = () => {
  router.push('/admin/work-plan/logs/create')
}

/**
 * Êü•ÁúãËÆ°ÂàíËØ¶ÊÉÖ
 */
const viewPlanDetail = (planId) => {
  router.push(`/admin/work-plan/plans/${planId}`)
}

/**
 * Êü•ÁúãÊó•ÂøóËØ¶ÊÉÖ
 */
const viewLogDetail = (logId) => {
  router.push(`/admin/work-plan/logs/${logId}`)
}

/**
 * Êü•ÁúãÊâÄÊúâÂæÖÂäû‰∫ãÈ°π
 */
const viewAllTodos = () => {
  router.push('/admin/work-plan/plans?status=pending,in_progress')
}

/**
 * Êü•ÁúãÊâÄÊúâÂ∑•‰ΩúÊó•Âøó
 */
const viewAllLogs = () => {
  router.push('/admin/work-plan/logs')
}

/**
 * ÂàùÂßãÂåñÈÄöÁü•Ëá™Âä®ÊªöÂä®ÔºàÊ∞¥Âπ≥ÂêëÂ∑¶ÊªöÂä®Ôºâ
 */
const initNoticeAutoScroll = () => {
  if (!noticeScrollRef.value) return
  
  const scrollContainer = noticeScrollRef.value
  let scrollLeft = 0
  const scrollStep = 1 // ÊØèÊ¨°ÊªöÂä®ÁöÑÂÉèÁ¥†
  const scrollDelay = 30 // ÊªöÂä®Èó¥ÈöîÔºàÊØ´ÁßíÔºâ
  const pauseTime = 1000 // ÊªöÂä®Âà∞Âè≥Á´ØÂêéÁöÑÊöÇÂÅúÊó∂Èó¥ÔºàÊØ´ÁßíÔºâ
  
  const autoScroll = () => {
    if (!scrollContainer) return
    
    const maxScrollLeft = scrollContainer.scrollWidth - scrollContainer.clientWidth
    
    if (maxScrollLeft <= 0) {
      // ÂÜÖÂÆπ‰∏çË∂≥‰ª•ÊªöÂä®
      return
    }
    
    if (scrollLeft >= maxScrollLeft) {
      // ÊªöÂä®Âà∞Âè≥Á´ØÔºåÁü≠ÊöÇÊöÇÂÅúÂêéÂπ≥ÊªëÈáçÁΩÆÂà∞Â∑¶Á´Ø
      setTimeout(() => {
        scrollLeft = 0
        scrollContainer.scrollLeft = 0
      }, pauseTime)
    } else {
      scrollLeft += scrollStep
      scrollContainer.scrollLeft = scrollLeft
    }
  }
  
  // ÂêØÂä®Ëá™Âä®ÊªöÂä®
  noticeScrollTimer = setInterval(autoScroll, scrollDelay)
  
  // Èº†Ê†áÊÇ¨ÂÅúÊó∂ÊöÇÂÅúÊªöÂä®
  scrollContainer.addEventListener('mouseenter', () => {
    if (noticeScrollTimer) {
      clearInterval(noticeScrollTimer)
      noticeScrollTimer = null
    }
  })
  
  // Èº†Ê†áÁ¶ªÂºÄÊó∂ÊÅ¢Â§çÊªöÂä®
  scrollContainer.addEventListener('mouseleave', () => {
    if (!noticeScrollTimer) {
      noticeScrollTimer = setInterval(autoScroll, scrollDelay)
    }
  })
}

/**
 * Ê∏ÖÁêÜËá™Âä®ÊªöÂä®ÂÆöÊó∂Âô®
 */
const clearNoticeAutoScroll = () => {
  if (noticeScrollTimer) {
    clearInterval(noticeScrollTimer)
    noticeScrollTimer = null
  }
}

/**
 * Á™óÂè£Â§ßÂ∞èÂèòÂåñÂ§ÑÁêÜÂáΩÊï∞
 */
const handleResize = () => {
  if (barChart) {
    barChart.resize()
  }
}

// ÁªÑ‰ª∂ÊåÇËΩΩÊó∂Ëé∑ÂèñÊï∞ÊçÆ
onMounted(async () => {
  // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
  try {
    await userStore.fetchProfile()
  } catch (error) {
    console.error('Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•:', error)
  }
  
  // ÂàùÂßãÂåñÊó∂Èó¥ÊòæÁ§∫
  updateCurrentDateTime()
  // ÂêØÂä®Êó∂Èó¥Êõ¥Êñ∞ÂÆöÊó∂Âô®ÔºåÊØèÁßíÊõ¥Êñ∞‰∏ÄÊ¨°
  timeUpdateTimer = setInterval(() => {
    updateCurrentDateTime()
    // Êõ¥Êñ∞Ââ©‰ΩôÊó∂Èó¥Ëß¶ÂèëÂô®Ôºå‰ΩøÂæÖÂäû‰∫ãÈ°πÁöÑÂâ©‰ΩôÊó∂Èó¥ÂÆûÊó∂Êõ¥Êñ∞
    timeUpdateTrigger.value++
  }, 1000)
  
  await refreshData()
  // Á°Æ‰øùDOMÊ∏≤ÊüìÂÆåÊàêÂêéÂàùÂßãÂåñÂõæË°®ÂíåËá™Âä®ÊªöÂä®
  await nextTick()
  initBarChart()
  initNoticeAutoScroll()
  
  // Ê∑ªÂä†Á™óÂè£Â§ßÂ∞èÂèòÂåñÁõëÂê¨Âô®
  window.addEventListener('resize', handleResize)
})

// ÁªÑ‰ª∂Âç∏ËΩΩÊó∂Ê∏ÖÁêÜÂÆöÊó∂Âô®ÂíåÁõëÂê¨Âô®
onUnmounted(() => {
  clearNoticeAutoScroll()
  // Ê∏ÖÁêÜÊó∂Èó¥Êõ¥Êñ∞ÂÆöÊó∂Âô®
  if (timeUpdateTimer) {
    clearInterval(timeUpdateTimer)
    timeUpdateTimer = null
  }
  // ÁßªÈô§Á™óÂè£Â§ßÂ∞èÂèòÂåñÁõëÂê¨Âô®
  window.removeEventListener('resize', handleResize)
  // ÈîÄÊØÅÂõæË°®ÂÆû‰æã
  if (barChart) {
    barChart.dispose()
    barChart = null
  }
})
</script>

<style scoped>
* {
  margin: 0;
}

/* ‰ª™Ë°®ÁõòÂÜÖÂÆπÂå∫ÂüüÊ†∑Âºè */
.dashboard-content.el-card {
  background: #fff;
  margin-top: 8px;
  border: none;
  box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
  border-radius: 12px;
}

/* ‰∏ªË¶ÅÂÜÖÂÆπÂç°ÁâáÊ†∑Âºè */
.main-content-card.el-card {
  margin-top: 24px;
  border: none;
  box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
  border-radius: 12px;
}

/* È°µÈù¢Â§¥ÈÉ® */
.page-header {
  /* padding: 16px 24px; */
  color: #333;
  position: relative;
  overflow: hidden;
}

.page-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="%23ffffff" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>') repeat;
  pointer-events: none;
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: relative;
  z-index: 1;
}

.header-left {
  flex: 1;
}

.page-title {
  display: flex;
  align-items: center;
  gap: 12px;
  margin: 0 0 6px 0;
  font-size: 24px;
  font-weight: 700;
  color: #333;
}

.title-icon {
  font-size: 28px;
  color: #f39c12;
}

/* ÁæéÂåñÁöÑÊ¨¢ËøéËØçÊ†∑Âºè */
.welcome-message {
  margin: 0;
  animation: fadeInUp 0.8s ease-out;
}
 
.welcome-line {
  margin: 0;
  display: flex;
  align-items: center;
  gap: 24px;
  font-size: 16px;
  font-weight: 500;
}

.greeting-section {
  display: flex;
  align-items: center;
  gap: 4px;
}

.greeting-emoji {
  font-size: 20px;
  animation: bounce 2s infinite;
  display: inline-block;
}

.greeting-words {
  color: #409eff;
  font-weight: normal;
  text-shadow: 0 1px 2px rgba(64, 158, 255, 0.1);
}

.user-name {
  color: #e6a23c;
  font-weight: normal;
  background: linear-gradient(45deg, #e6a23c, #f39c12);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.exclamation {
  color: #f56c6c;
  font-weight: normal;
  animation: pulse 1.5s ease-in-out infinite;
}

.date-section {
  color: #666;
  font-size: 13px;
  font-weight: 400;
  display: flex;
  align-items: center;
  gap: 6px;
  opacity: 0.9;
}

.calendar-icon {
  color: #909399;
  font-size: 14px;
}

.weekday-tag {
  margin-left: 8px;
  font-weight: 500;
  border-radius: 12px;
  animation: fadeInUp 0.6s ease-out;
}

/* Âä®ÁîªÊïàÊûú */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    transform: translateY(0);
  }
  40% {
    transform: translateY(-3px);
  }
  60% {
    transform: translateY(-2px);
  }
}

@keyframes pulse {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.1);
  }
  100% {
    transform: scale(1);
  }
}

.header-right {
  display: flex;
  align-items: center;
  gap: 24px;
}

.time-filter {
  display: flex;
  align-items: center;
  gap: 8px;
}

.filter-label {
  color: #666;
  font-size: 14px;
  font-weight: 500;
}

.time-select {
  width: 120px;
}

.quick-actions {
  display: flex;
  gap: 12px;
}

/* ÂõæË°®ÂÆπÂô®Ê†∑Âºè */
.charts-wrapper {
  margin-bottom: 10px;
}

.charts-card {
  height: 200px;
}

.chart-item {
  height: 100%;
  /*padding: 12px;*/
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.bar-chart-item {
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: stretch;
  width: 100%;
}

.bar-chart-item .middle-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: space-around;
  gap: 2px;
  width: 100%;
  padding: 0;
}

.pie-chart-item {
  height: 100%;
  padding: 0;
  display: flex !important;
  flex-direction: row !important;
  justify-content: center;
  align-items: center;
}

.mx-1 {
  margin-left: 0.25rem;
}

/* ÈÄöÁü•ÂÖ¨ÂëäÂÆπÂô®Ê†∑Âºè */


/* Êó•ÂéÜÂç°ÁâáÊ†∑Âºè */
.calendar-card {
  height: 100%;
}

/* ‰øùÁïôÂéüÊúâÁöÑstat-cardÊ†∑ÂºèÁî®‰∫éÂÖ∂‰ªñÂú∞Êñπ */
.stat-card {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
  max-height: 75px;
  display: flex;
  flex-direction: column;
}

.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.card-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 18px;
  font-weight: 600;
  color: #2c3e50;
}

.card-icon {
  font-size: 20px;
  color: #667eea;
}

.filter-btn {
  color: #667eea;
  font-weight: 500;
}

/* Â∑¶Âç°ÁâáÔºöÂÆåÊàêÊÉÖÂÜµ */
.left-card {
  width: 100%;
  overflow: hidden;
}

.completion-chart {
  height: 100%;
  padding: 12px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: stretch;
}

.completion-grid {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 1px;
  width: 100%;
  justify-content: space-around;
}

.completion-item {
  display: flex;
  align-items: center;
  gap: 10px;
  /* padding: 2px 0; */
  white-space: nowrap;
  overflow: visible;
}

.completion-progress {
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
  min-width: 0;
}

.completion-progress .el-progress {
  flex: 1;
  min-width: 0;
}

.completion-progress {
  font-size: 14px;
  color: #2c3e50;
  font-weight: 600;
  min-width: 40px;
  flex-shrink: 0;
  white-space: nowrap;
}

/* ‰∏≠ÈÉ®Âç°ÁâáÔºöËÆ°ÂàíÁªüËÆ°ÂíåÊü±ÂΩ¢Âõæ */
.middle-card {
  width: 100%;
  overflow: hidden;
  flex: 1;
  display: flex;
  flex-direction: column;
}

.middle-card .middle-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: space-around;
  gap: 6px;
  width: 100%;
  padding: 0 0 12px 0;
}

.stats-text {
  display: flex;
  justify-content: space-around;
  gap: 15px;
  white-space: nowrap;
}

.stats-tags {
  margin-bottom: 2px;
  white-space: nowrap;
  overflow: hidden;
  min-height: 24px;
}

.text-center {
  text-align: center;
}

.stat-text-item {
  text-align: center;
}

.stat-label {
  display: block;
  font-size: 12px;
  color: #7f8c8d;
  font-weight: 500;
  margin-bottom: 4px;
}

.stat-number {
  font-size: 24px;
  font-weight: 700;
  color: #2c3e50;
}

.stat-number.completed { color: #27ae60; }

.bar-chart {
  display: flex;
  flex-direction: column;
  gap: 8px;
  width: 100%;
  overflow: hidden;
}

.echarts-container {
  width: 100%;
  height: 120px;
  min-width: 0;
}

/* Âè≥Âç°ÁâáÔºöÂúÜÁéØÂõæ */
.right-card {
  width: 100%;
  overflow: hidden;
  flex: 1;
  display: flex;
  flex-direction: column;
}

.right-card .pie-charts {
  flex: 1;
  width: 100%;
  padding: 0;
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
}

.pie-item {
  display: inline-block;
  vertical-align: top;
  margin: 0 8px;
  text-align: center;
}

.pie-center {
  text-align: center;
}

.pie-value {
  font-size: 12px;
  white-space: nowrap;  
}

.pie-label {
  font-size: 13px;
  text-align: center;
  display: block;
  max-width: 100%;
  margin-top: 5px;
}

/* ÊâÄÊúâÂúÜÁéØËøõÂ∫¶Êù°ËÉåÊôØËâ≤ËÆæÁΩÆ */
.pie-charts .pie-item :deep(.el-progress-circle__track) {
  stroke: #EBEEF5;
}



/* ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü */
.content-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.content-section {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  padding: 24px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 2px solid #ecf0f1;
}

.section-title {
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 0;
  font-size: 18px;
  font-weight: 600;
  color: #2c3e50;
}

.todo-badge {
  margin-left: 8px;
}

.view-all-btn {
  color: #667eea;
  font-weight: 500;
}

/* ÂæÖÂäû‰∫ãÈ°π */
.todo-container {
  overflow-y: auto;
}

/* ÊúÄËøëÂä®ÊÄÅ */
.activity-container {
  overflow-y: auto;
}

.todo-list {
  list-style: none;
  margin: 0;
  padding: 0;
  height: 100%;
  overflow-y: auto;
  padding-right: 8px;
}

.todo-item {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 12px 0;
  border-bottom: 1px solid #ebeef5;
  cursor: pointer;
  transition: all 0.2s ease;
}

.todo-item:hover {
  background: #f5f7fa;
  padding-left: 8px;
  margin-left: -8px;
  margin-right: -8px;
}

.todo-item:last-child {
  border-bottom: none;
}

.todo-priority {
  width: 4px;
  height: 40px;
  border-radius: 2px;
  flex-shrink: 0;
  margin-top: 4px;
}

.loading-item,
.end-item {
  list-style: none;
  padding: 12px 0;
}

.priority-high { background: #e74c3c; }
.priority-medium { background: #f39c12; }
.priority-low { background: #27ae60; }

.todo-main {
  flex: 1;
  min-width: 0;
}

.todo-header {
  display: flex;
  justify-content: flex-start;
  align-items: flex-start;
  margin-bottom: 8px;
}

.title-badge {
  position: relative;
  display: inline-block;
}

/* ÂæΩÁ´†ÊñáÂ≠óÊ†∑Âºè */
.title-badge :deep(.el-badge__content) {
  font-family: 'DengXian', 'Á≠âÁ∫ø', sans-serif;
  font-size: 9px;
  line-height: 1;
}

.todo-title {
  margin: 0;
  font-size: 14px;
  font-weight: 600;
  color: #2c3e50;
  line-height: 1.4;
  padding-right: 8px;
}

/* ‰∏âÊ†èÂìçÂ∫îÂºèÂ∏ÉÂ±Ä */
.todo-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  font-size: 12px;
  color: #7f8c8d;
  gap: 8px;
}

.todo-meta-left {
  flex: 1;
  min-width: 0;
}

.todo-meta-center {
  flex: 1;
  text-align: left;
  min-width: 0;
}

.todo-meta-right {
  flex: 1;
  min-width: 0;
  text-align: right;
}

/* ËøõÂ∫¶Êù°Ê†∑Âºè */
.todo-progress-bar {
  width: 100%;
  max-width: 200px;
}

.todo-progress-bar :deep(.el-progress-bar__outer) {
  border-radius: 10px;
}

.todo-progress-bar :deep(.el-progress-bar__inner) {
  border-radius: 10px;
}

.todo-progress-bar :deep(.el-progress__text) {
  font-family: 'Arial', 'Helvetica', 'Times New Roman', sans-serif;
  font-size: 9px;
  font-weight: 600;
  color: white;
}

.todo-subtitle,
.todo-deadline {
  display: flex;
  align-items: center;
  gap: 4px;
}

.todo-meta-center .todo-deadline {
  justify-content: flex-start;
}

.todo-progress {
  display: flex;
  align-items: center;
  gap: 8px;
}

.progressbar-value{
  font-size: 12px;
  font-weight: 500;
  min-width: 35px;
}

/* Âä†ËΩΩÂíåÁ©∫Áä∂ÊÄÅ */
.loading-state,
.empty-state {
  padding: 40px 20px;
  text-align: center;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 1200px) {
  .pie-item {
    margin: 0 8px;
  }
  
  .pie-item :deep(.el-progress-circle) {
    width: 65px !important;
    height: 65px !important;
  }
  
  .pie-label {
    font-size: 11px;
  }
}

@media (max-width: 1000px) {
  .pie-item {
    margin: 0 6px;
  }
  
  .pie-item :deep(.el-progress-circle) {
    width: 55px !important;
    height: 55px !important;
  }
  
  .pie-label {
    font-size: 10px;
  }
}

@media (max-width: 800px) {
  .pie-item {
    margin: 0 4px;
  }
  
  .pie-item :deep(.el-progress-circle) {
    width: 45px !important;
    height: 45px !important;
  }
  
  .pie-label {
    font-size: 9px;
  }
}

@media (max-width: 768px) {
  .modern-dashboard {
    padding: 10px;
  }
  
  .header-content {
    flex-direction: column;
    gap: 16px;
    text-align: center;
  }
  
  .header-right {
    flex-direction: column;
    gap: 16px;
  }
  
  .content-grid {
    display: flex;
    flex-direction: column;
  }
  
  .bars-container {
    height: 60px;
  }
  
  /* ÂæÖÂäû‰∫ãÈ°πÂìçÂ∫îÂºèÂ∏ÉÂ±Ä */
  .todo-meta {
    flex-direction: column;
    gap: 4px;
    align-items: flex-start;
  }
  
  .todo-meta-center {
    text-align: left;
  }
  
  .todo-meta-center .todo-deadline {
    justify-content: flex-start;
  }
  
  .todo-meta-right {
    text-align: left;
    width: 100%;
  }
  
  .pie-charts {
    flex-direction: column;
    gap: 12px;
  }
  
  /* ÁßªÂä®Á´Ø‰∏âÊ†èÂ∏ÉÂ±ÄË∞ÉÊï¥ */
  .todo-meta {
    gap: 4px;
  }
  
  .todo-meta-left,
  .todo-meta-center,
  .todo-meta-right {
    font-size: 11px;
  }
  
  .todo-subtitle,
  .todo-deadline {
    gap: 2px;
  }
  
  .todo-progress-bar {
    width: 100%;
    min-width: 60px;
  }
}

@media (max-width: 480px) {
  .page-title {
    font-size: 24px;
  }
  
  .quick-actions {
    width: 100%;
    justify-content: center;
  }
  
  .stats-text {
    flex-direction: column;
    gap: 12px;
  }
  
  .bars-container {
    height: 50px;
  }
}

/* ÊªöÂä®Êù°Ê†∑Âºè */
.todo-container::-webkit-scrollbar,
.activity-container::-webkit-scrollbar {
  width: 6px;
}

.todo-container::-webkit-scrollbar-track,
.activity-container::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

/* Êó•ÂéÜÂç°ÁâáÊ†∑Âºè */
.calendar-card {
  height: 100%;
  display: flex;
  flex-direction: column;
}

.calendar-content {
  flex: 1;
  padding: 2px;
  overflow: hidden;
}

.dashboard-calendar {
  height: 100%;
}

.dashboard-calendar :deep(.el-calendar__header) {
  padding: 8px 0;
  border-bottom: 1px solid #ebeef5;
  text-align: center;
}

.dashboard-calendar :deep(.el-calendar__title) {
  font-size: 14px;
  font-weight: 600;
  color: #2c3e50;
  text-align: center;
  margin: 0 auto;
}

.dashboard-calendar :deep(.el-calendar__button-group) {
  display: none;
}

.dashboard-calendar :deep(.el-calendar__body) {
  padding: 4px 0;
}

.dashboard-calendar :deep(.el-calendar-table) {
  font-size: 14px;
}

.dashboard-calendar :deep(.el-calendar-table thead th) {
  padding: 0;
  font-weight: 600;
  color: white;
  background-color: #409EFF;
  border-bottom: 1px solid #ebeef5;
  width: 24px;
  height: 32px;
  text-align: center;
  vertical-align: middle;
  line-height: 24px;
}

.dashboard-calendar :deep(.el-calendar-table .el-calendar-day) {
  padding: 0;
  width: 24px;
  height: 28px;
  text-align: center;
  vertical-align: middle;
  display: flex;
  align-items: center;
  justify-content: center;
}

.dashboard-calendar :deep(.el-calendar-table td) {
  padding: 0;
  text-align: center;
  vertical-align: middle;
  border: none;
}

.calendar-day {
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 2px;
  font-size: 11px;
  transition: all 0.2s ease;
  margin: auto;
}

.calendar-day.is-today {
  background: #F56C6C;
  color: white;
  font-weight: 600;
}

/* ÊòüÊúüÊó•ÁöÑÊó•ÊúüÂ≠ó‰ΩìÈ¢úËâ≤‰∏∫Á∫¢Ëâ≤ */
.dashboard-calendar :deep(.el-calendar-table td:first-child .calendar-day) {
  color: #f56c6c;
  font-weight: 700;
}

.dashboard-calendar :deep(.el-calendar-table td:first-child .calendar-day.is-today) {
  background: #F56C6C;
  color: white;
}

/* ‰∏ä‰∏ãÈÉ®ÂàÜÂ∏ÉÂ±ÄÊ†∑Âºè */
.upper-section {
  margin-bottom: 20px;
}

/* ÈÄöÁü•ÂÖ¨ÂëäÊ®°ÂùóÊ†∑Âºè */
.notice-card {
  display: flex;
  flex-direction: column;
}

.notice-card .el-col {
  height: 100%;
}

.notice-header {
  display: flex;
  align-items: center;
  justify-content: center;
  border-right: 1px solid #ebeef5;
  height: 100%;
}

.notice-title {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 8px;
  margin: 0;
  font-size: 15px;
  font-weight: 700;
  color: #1a1a1a;
  text-align: center;
  line-height: 1.3;
}

.notice-title .el-icon {
  color: #409eff;
  font-size: 24px;
}

.notice-title span {
  white-space: nowrap;
  color: #1a1a1a;
}

.notice-scroll {
  height: 100%;
  overflow-x: auto;
  overflow-y: hidden;
  white-space: nowrap;
  display: flex;
  align-items: center;
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE and Edge */
}

.notice-item {
  display: inline-flex;
  align-items: flex-start;
  gap: 12px;
  padding: 12px 20px;
  margin-right: 24px;
  background: transparent;
  transition: all 0.2s ease;
  flex-shrink: 0;
  min-width: 300px;
  cursor: pointer;
}

.notice-item:hover {
  background: rgba(64, 158, 255, 0.1);
  border-radius: 6px;
}

.notice-item.unread {
  background: rgba(255, 193, 7, 0.05);
  border-left: 3px solid #ffc107;
}

.notice-item.unread:hover {
  background: rgba(255, 193, 7, 0.15);
}

.notice-dot {
  width: 8px;
  height: 8px;
  background: #409eff;
  border-radius: 50%;
  flex-shrink: 0;
  margin-top: 6px;
}

.notice-dot.unread {
  background: #ffc107;
  box-shadow: 0 0 6px rgba(255, 193, 7, 0.5);
}

.notice-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.notice-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 4px;
}

.notice-text-wrapper {
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
}

.notice-text {
  font-size: 15px;
  color: #2c3e50;
  line-height: 1.5;
  font-weight: 500;
}

.notice-text.unread {
  font-weight: 600;
  color: #1a1a1a;
}

.sticky-tag {
  margin-left: 4px;
}

.type-tag {
  margin-left: 4px;
}

.notice-content {
  font-size: 13px;
  color: #606266;
  line-height: 1.4;
 /* max-width: 250px;*/
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.notice-time {
  font-size: 12px;
  color: #909399;
  white-space: nowrap;
  margin-left: 20px;
  flex-shrink: 0;
}

/* ÈöêËóèÊ∞¥Âπ≥ÊªöÂä®Êù°‰ª•Ëé∑ÂæóÊõ¥Â•ΩÁöÑËßÜËßâÊïàÊûú */
.notice-scroll::-webkit-scrollbar {
  display: none; /* Chrome, Safari and Opera */
}

.dashboard-calendar :deep(.el-calendar-table .el-calendar-day:hover .calendar-day) {
  background: #ecf5ff;
  color: #409eff;
}

.dashboard-calendar :deep(.el-calendar-table .el-calendar-day:hover .calendar-day.is-today) {
  background: #e85a5a;
  color: white;
}

.todo-container::-webkit-scrollbar-thumb,
.activity-container::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

.todo-container::-webkit-scrollbar-thumb:hover,
.activity-container::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

/* ‰ªªÂä°ÊïàÁéáÂæΩÁ´†Ê†∑Âºè */
.item {
  display: inline-block;
  vertical-align: top;
  margin: -6px 0 0 4px;
  padding-top: 3px;
}
</style>