# Nginx配置文件示例
# 用于在数据库服务器(192.168.1.57)上部署文件服务器
# 文件位置: /etc/nginx/sites-available/file-server

server {
    listen 8080;
    server_name 192.168.1.57;
    
    # 文件服务器根目录
    root /;
    
    # 启用目录浏览（可选）
    autoindex on;
    autoindex_exact_size off;
    autoindex_localtime on;
    
    # 文件访问路径配置
    location /files/ {
        # 移除/files前缀，直接访问系统路径
        alias /;
        
        # 安全设置
        # 禁止访问系统敏感目录
        location ~ ^/files/(proc|sys|dev|etc|boot|root|tmp|var/log)/ {
            deny all;
            return 403;
        }
        
        # 允许的文件类型
        location ~* \.(jpg|jpeg|png|gif|bmp|webp|pdf|doc|docx|xls|xlsx|ppt|pptx|mp4|avi|mov|wmv|flv|mp3|wav|wma|aac|zip|rar|7z|tar|gz)$ {
            # CORS设置，允许跨域访问
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
            add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
            
            # 缓存设置
            expires 1d;
            add_header Cache-Control "public, immutable";
            
            # 支持断点续传
            add_header Accept-Ranges bytes;
            
            # 文件下载设置
            add_header Content-Disposition 'inline';
            
            try_files $uri =404;
        }
        
        # 拒绝其他文件类型
        location ~* \.(exe|bat|cmd|sh|php|asp|jsp)$ {
            deny all;
            return 403;
        }
    }
    
    # Windows共享盘访问配置
    location /files/C$/ {
        alias /mnt/c$/;
        try_files $uri =404;
    }
    
    location /files/D$/ {
        alias /mnt/d$/;
        try_files $uri =404;
    }
    
    location /files/E$/ {
        alias /mnt/e$/;
        try_files $uri =404;
    }
    
    # 共享文件夹访问
    location /files/shared/ {
        alias /mnt/shared/;
        try_files $uri =404;
    }
    
    # 错误页面
    error_page 404 /404.html;
    location = /404.html {
        return 404 '{"error": "File not found", "code": 404}';
        add_header Content-Type application/json;
    }
    
    error_page 403 /403.html;
    location = /403.html {
        return 403 '{"error": "Access denied", "code": 403}';
        add_header Content-Type application/json;
    }
    
    # 日志配置
    access_log /var/log/nginx/file-server-access.log;
    error_log /var/log/nginx/file-server-error.log;
    
    # 安全设置
    # 隐藏Nginx版本
    server_tokens off;
    
    # 限制请求大小
    client_max_body_size 100M;
    
    # 限制连接数
    limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;
    limit_conn conn_limit_per_ip 10;
    
    # 限制请求频率
    limit_req_zone $binary_remote_addr zone=req_limit_per_ip:10m rate=10r/s;
    limit_req zone=req_limit_per_ip burst=20 nodelay;
}

# 部署说明:
# 1. 将此配置文件保存为 /etc/nginx/sites-available/file-server
# 2. 创建软链接: sudo ln -s /etc/nginx/sites-available/file-server /etc/nginx/sites-enabled/
# 3. 创建挂载点:
#    sudo mkdir -p /mnt/c$ /mnt/d$ /mnt/e$ /mnt/shared
# 4. 挂载Windows共享盘:
#    sudo mount -t cifs //192.168.1.57/C$ /mnt/c$ -o username=admin,password=xxx
#    sudo mount -t cifs //192.168.1.57/D$ /mnt/d$ -o username=admin,password=xxx
#    sudo mount -t cifs //192.168.1.57/E$ /mnt/e$ -o username=admin,password=xxx
# 5. 测试配置: sudo nginx -t
# 6. 重启Nginx: sudo systemctl restart nginx
# 7. 测试访问: curl http://192.168.1.57:8080/files/C$/path/to/file.jpg
