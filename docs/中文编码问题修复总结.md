# ä¸­æ–‡ç¼–ç é—®é¢˜ä¿®å¤æ€»ç»“

## ğŸ› **é—®é¢˜æè¿°**

è·¯å¾„æ˜ å°„é…ç½®ä¿å­˜åˆ°æ•°æ®åº“ä¸­çš„ä¸­æ–‡è·¯å¾„éƒ½æ˜¯ä¹±ç ï¼Œæ˜¾ç¤ºä¸ºç±»ä¼¼ `ï¿½ï¿½Ê±ï¿½Ä¼ï¿½Ó³ï¿½ï¿½` çš„ä¹±ç å­—ç¬¦ã€‚

## ğŸ” **é—®é¢˜åˆ†æ**

### æ ¹æœ¬åŸå› 
1. **SQL Serverå‚æ•°ç»‘å®šç¼ºå°‘ç±»å‹å£°æ˜**ï¼šæ²¡æœ‰æ˜ç¡®æŒ‡å®š`sql.NVarChar`ç±»å‹
2. **æ•°æ®åº“è¿æ¥ç¼ºå°‘å­—ç¬¦ç¼–ç è®¾ç½®**ï¼šè¿æ¥é…ç½®ä¸­æ²¡æœ‰è®¾ç½®UTF-8ç¼–ç 
3. **å·²å­˜åœ¨ä¹±ç æ•°æ®**ï¼šæ•°æ®åº“ä¸­å·²ç»å­˜å‚¨äº†ä¹±ç æ•°æ®

### æŠ€æœ¯åŸå› 
- SQL Serverçš„`NVARCHAR`å­—æ®µéœ€è¦æ˜ç¡®æŒ‡å®šå‚æ•°ç±»å‹ä¸º`sql.NVarChar`
- æ²¡æœ‰è®¾ç½®æ•°æ®åº“è¿æ¥çš„å­—ç¬¦ç¼–ç å’Œæ’åºè§„åˆ™
- ä¸­æ–‡å­—ç¬¦åœ¨ä¼ è¾“å’Œå­˜å‚¨è¿‡ç¨‹ä¸­ç¼–ç è½¬æ¢é”™è¯¯

## ğŸ› ï¸ **ä¿®å¤æ–¹æ¡ˆ**

### 1. ä¿®å¤SQLå‚æ•°ç»‘å®š

#### ä¿®å¤å‰
```javascript
await request
  .input('Name', mapping.name)
  .input('LocalPattern', mapping.localPattern)
  .input('TargetPattern', mapping.targetPattern)
```

#### ä¿®å¤å
```javascript
await request
  .input('Name', sql.NVarChar, mapping.name)
  .input('LocalPattern', sql.NVarChar, mapping.localPattern)
  .input('TargetPattern', sql.NVarChar, mapping.targetPattern)
  .input('Description', sql.NVarChar, mapping.description || '')
  .input('IsActive', sql.Bit, mapping.isActive !== false ? 1 : 0)
```

### 2. ä¿®å¤æ•°æ®åº“è¿æ¥é…ç½®

#### ä¿®å¤å‰
```javascript
options: {
  encrypt: false,
  trustServerCertificate: true,
  enableArithAbort: true,
  useUTC: false,
  requestTimeout: 30000,
  connectionTimeout: 30000,
  parseJSON: true
}
```

#### ä¿®å¤å
```javascript
options: {
  encrypt: false,
  trustServerCertificate: true,
  enableArithAbort: true,
  useUTC: false,
  requestTimeout: 30000,
  connectionTimeout: 30000,
  parseJSON: true,
  charset: 'utf8',             // è®¾ç½®å­—ç¬¦ç¼–ç ä¸ºUTF-8
  collation: 'Chinese_PRC_CI_AS' // è®¾ç½®ä¸­æ–‡æ’åºè§„åˆ™
}
```

### 3. æ¸…ç†ä¹±ç æ•°æ®

åˆ›å»ºä¿®å¤è„šæœ¬æ¸…ç†ç°æœ‰ä¹±ç æ•°æ®ï¼š
```sql
-- æ¸…ç†ä¹±ç æ•°æ®
DELETE FROM PathMappingConfig;

-- é‡æ–°æ’å…¥æ­£ç¡®çš„ä¸­æ–‡æ•°æ®
INSERT INTO PathMappingConfig (Name, LocalPattern, TargetPattern, Description, IsActive, CreatedAt, UpdatedAt) VALUES
(N'Excelä¸´æ—¶æ–‡ä»¶æ˜ å°„', N'C:\Users\*\AppData\Roaming\Microsoft\Excel\*', N'\\tj_server\å·¥ä½œ\å“è´¨éƒ¨\ç”Ÿäº§å¼‚å¸¸å‘¨æŠ¥è€ƒæ ¸ç»Ÿè®¡\*', N'Excelä¸´æ—¶æ–‡ä»¶æ˜ å°„åˆ°tj_serverå…±äº«ç›˜', 1, GETDATE(), GETDATE()),
(N'2025å¹´å¼‚å¸¸æ±‡æ€»æ˜ å°„', N'*2025å¹´å¼‚å¸¸æ±‡æ€»\*', N'D:\WebServer\backend\uploads\attachments\2025å¹´å¼‚å¸¸æ±‡æ€»\*', N'2025å¹´å¼‚å¸¸æ±‡æ€»æ–‡ä»¶æ˜ å°„åˆ°æœåŠ¡å™¨å­˜å‚¨è·¯å¾„', 1, GETDATE(), GETDATE()),
(N'æœåŠ¡å™¨å­˜å‚¨æ˜ å°„', N'2025å¹´å¼‚å¸¸æ±‡æ€»\*', N'D:\WebServer\backend\uploads\attachments\2025å¹´å¼‚å¸¸æ±‡æ€»\*', N'ç›¸å¯¹è·¯å¾„åˆ°æœåŠ¡å™¨å­˜å‚¨è·¯å¾„çš„æ˜ å°„', 1, GETDATE(), GETDATE());
```

## âœ… **ä¿®å¤éªŒè¯**

### APIæµ‹è¯•ç»“æœ

#### ä¿å­˜ä¸­æ–‡é…ç½®
```bash
curl -X PUT http://localhost:3001/api/import/path-mapping-config \
  -H "Content-Type: application/json; charset=utf-8" \
  -d '{
    "pathMappings": [
      {
        "name": "Excelä¸´æ—¶æ–‡ä»¶æ˜ å°„",
        "localPattern": "C:\\Users\\*\\AppData\\Roaming\\Microsoft\\Excel\\*",
        "targetPattern": "\\\\tj_server\\å·¥ä½œ\\å“è´¨éƒ¨\\ç”Ÿäº§å¼‚å¸¸å‘¨æŠ¥è€ƒæ ¸ç»Ÿè®¡\\*",
        "description": "Excelä¸´æ—¶æ–‡ä»¶æ˜ å°„åˆ°tj_serverå…±äº«ç›˜"
      }
    ]
  }'
```

**è¿”å›ç»“æœ**ï¼š
```json
{
  "success": true,
  "message": "è·¯å¾„æ˜ å°„é…ç½®ä¿å­˜æˆåŠŸ"
}
```

#### éªŒè¯ä¸­æ–‡æ˜¾ç¤º
```bash
curl -X GET http://localhost:3001/api/import/path-mapping-config
```

**è¿”å›ç»“æœ**ï¼š
```json
{
  "pathMappings": [
    {
      "id": 1,
      "name": "Excelä¸´æ—¶æ–‡ä»¶æ˜ å°„",
      "localPattern": "C:\\Users\\*\\AppData\\Roaming\\Microsoft\\Excel\\*",
      "targetPattern": "\\\\tj_server\\å·¥ä½œ\\å“è´¨éƒ¨\\ç”Ÿäº§å¼‚å¸¸å‘¨æŠ¥è€ƒæ ¸ç»Ÿè®¡\\*",
      "description": "Excelä¸´æ—¶æ–‡ä»¶æ˜ å°„åˆ°tj_serverå…±äº«ç›˜"
    }
  ]
}
```

### ä¿®å¤æ•ˆæœå¯¹æ¯”

#### ä¿®å¤å‰ï¼ˆä¹±ç ï¼‰
```
"name": "Excelï¿½ï¿½Ê±ï¿½Ä¼ï¿½Ó³ï¿½ï¿½"
"targetPattern": "\\\\localhost\\ï¿½ï¿½ï¿½ï¿½\\Æ·ï¿½Ê²ï¿½\\ï¿½ï¿½ï¿½ï¿½ï¿½ ì³£ï¿½Ü±ï¿½ï¿½ï¿½ï¿½ï¿½Í³ï¿½ï¿½\\*"
"description": "Excelï¿½ï¿½Ê±ï¿½Ä¼ï¿½Ó³ï¿½äµ½tj_serverï¿½ï¿½ï¿½ï¿½ï¿½ï¿½"
```

#### ä¿®å¤åï¼ˆæ­£å¸¸ï¼‰
```
"name": "Excelä¸´æ—¶æ–‡ä»¶æ˜ å°„"
"targetPattern": "\\\\tj_server\\å·¥ä½œ\\å“è´¨éƒ¨\\ç”Ÿäº§å¼‚å¸¸å‘¨æŠ¥è€ƒæ ¸ç»Ÿè®¡\\*"
"description": "Excelä¸´æ—¶æ–‡ä»¶æ˜ å°„åˆ°tj_serverå…±äº«ç›˜"
```

## ğŸ¯ **æŠ€æœ¯è¦ç‚¹**

### 1. SQL Serverä¸­æ–‡å¤„ç†æœ€ä½³å®è·µ
- **ä½¿ç”¨NVARCHARå­—æ®µ**ï¼šå­˜å‚¨Unicodeå­—ç¬¦
- **æ˜ç¡®å‚æ•°ç±»å‹**ï¼šä½¿ç”¨`sql.NVarChar`è€Œä¸æ˜¯è‡ªåŠ¨æ¨æ–­
- **è®¾ç½®æ’åºè§„åˆ™**ï¼šä½¿ç”¨`Chinese_PRC_CI_AS`æ”¯æŒä¸­æ–‡
- **ä½¿ç”¨Nå‰ç¼€**ï¼šSQLè¯­å¥ä¸­å­—ç¬¦ä¸²ä½¿ç”¨`N'ä¸­æ–‡'`æ ¼å¼

### 2. Node.js mssqlé©±åŠ¨é…ç½®
- **å­—ç¬¦ç¼–ç **ï¼šè®¾ç½®`charset: 'utf8'`
- **æ’åºè§„åˆ™**ï¼šè®¾ç½®`collation: 'Chinese_PRC_CI_AS'`
- **å‚æ•°ç»‘å®š**ï¼šæ˜ç¡®æŒ‡å®š`sql.NVarChar`ç±»å‹
- **è¿æ¥é€‰é¡¹**ï¼šç¡®ä¿`parseJSON: true`

### 3. æ•°æ®ä¼ è¾“ç¼–ç 
- **HTTPå¤´è®¾ç½®**ï¼š`Content-Type: application/json; charset=utf-8`
- **JSONç¼–ç **ï¼šç¡®ä¿JSONå­—ç¬¦ä¸²ä½¿ç”¨UTF-8ç¼–ç 
- **APIå“åº”**ï¼šæœåŠ¡å™¨å“åº”æ­£ç¡®è®¾ç½®ç¼–ç å¤´

## ğŸ“‹ **ä¿®å¤æ¸…å•**

### âœ… åç«¯ä¿®å¤
- [x] ä¿®å¤SQLå‚æ•°ç»‘å®šç±»å‹å£°æ˜
- [x] æ·»åŠ æ•°æ®åº“è¿æ¥å­—ç¬¦ç¼–ç é…ç½®
- [x] æ›´æ–°PathMappingConfigä¿å­˜é€»è¾‘
- [x] æ›´æ–°ConversionConfigä¿å­˜é€»è¾‘
- [x] æ¸…ç†æ•°æ®åº“ä¸­çš„ä¹±ç æ•°æ®

### âœ… æ•°æ®åº“ä¿®å¤
- [x] æ¸…ç†PathMappingConfigè¡¨ä¹±ç æ•°æ®
- [x] é‡æ–°æ’å…¥æ­£ç¡®çš„ä¸­æ–‡æ•°æ®
- [x] åˆ›å»ºConversionConfigè¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
- [x] æ’å…¥é»˜è®¤è½¬æ¢é…ç½®

### âœ… æµ‹è¯•éªŒè¯
- [x] APIä¿å­˜ä¸­æ–‡é…ç½®æµ‹è¯•
- [x] APIè·å–ä¸­æ–‡é…ç½®æµ‹è¯•
- [x] å‰ç«¯é¡µé¢ä¸­æ–‡æ˜¾ç¤ºæµ‹è¯•
- [x] æ•°æ®åº“ç›´æ¥æŸ¥è¯¢éªŒè¯

## ğŸš€ **é¢„é˜²æªæ–½**

### 1. å¼€å‘è§„èŒƒ
- æ‰€æœ‰æ¶‰åŠä¸­æ–‡çš„å­—æ®µéƒ½ä½¿ç”¨`sql.NVarChar`ç±»å‹
- æ•°æ®åº“è¿æ¥é…ç½®åŒ…å«å­—ç¬¦ç¼–ç è®¾ç½®
- APIè¯·æ±‚å¤´æ˜ç¡®æŒ‡å®šUTF-8ç¼–ç 

### 2. æµ‹è¯•è§„èŒƒ
- æ–°åŠŸèƒ½å¼€å‘æ—¶æµ‹è¯•ä¸­æ–‡å­—ç¬¦å¤„ç†
- æ•°æ®åº“æ“ä½œåéªŒè¯ä¸­æ–‡å­˜å‚¨æ­£ç¡®æ€§
- APIæµ‹è¯•åŒ…å«ä¸­æ–‡å­—ç¬¦åœºæ™¯

### 3. éƒ¨ç½²è§„èŒƒ
- ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“æ’åºè§„åˆ™è®¾ç½®æ­£ç¡®
- æœåŠ¡å™¨ç³»ç»Ÿç¼–ç è®¾ç½®ä¸ºUTF-8
- å®šæœŸæ£€æŸ¥ä¸­æ–‡æ•°æ®å®Œæ•´æ€§

## ğŸ‰ **ä¿®å¤æ€»ç»“**

é€šè¿‡ä»¥ä¸‹ä¿®å¤æªæ–½ï¼Œä¸­æ–‡ç¼–ç é—®é¢˜å·²å®Œå…¨è§£å†³ï¼š

1. **SQLå‚æ•°ç±»å‹æ˜ç¡®åŒ–**ï¼šæ‰€æœ‰ä¸­æ–‡å­—æ®µä½¿ç”¨`sql.NVarChar`
2. **æ•°æ®åº“è¿æ¥ä¼˜åŒ–**ï¼šæ·»åŠ UTF-8ç¼–ç å’Œä¸­æ–‡æ’åºè§„åˆ™
3. **ä¹±ç æ•°æ®æ¸…ç†**ï¼šæ¸…ç†å¹¶é‡æ–°æ’å…¥æ­£ç¡®çš„ä¸­æ–‡æ•°æ®
4. **ç¼–ç è§„èŒƒå»ºç«‹**ï¼šåˆ¶å®šä¸­æ–‡å­—ç¬¦å¤„ç†çš„å¼€å‘è§„èŒƒ

ç°åœ¨ç³»ç»Ÿå¯ä»¥ï¼š
- âœ… æ­£ç¡®ä¿å­˜åŒ…å«ä¸­æ–‡çš„è·¯å¾„æ˜ å°„é…ç½®
- âœ… æ­£ç¡®æ˜¾ç¤ºä¸­æ–‡è·¯å¾„å’Œæè¿°ä¿¡æ¯
- âœ… æ”¯æŒä¸­æ–‡æœç´¢å’Œæ’åºåŠŸèƒ½
- âœ… åœ¨å‰ç«¯ç•Œé¢æ­£ç¡®æ˜¾ç¤ºä¸­æ–‡å†…å®¹

ä¸­æ–‡ç¼–ç é—®é¢˜å·²å½»åº•è§£å†³ï¼Œç³»ç»Ÿçš„ä¸­æ–‡æ”¯æŒåŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼
