# 图片路径存储格式设计方案

## 当前问题分析

### 现有存储方式
- **字段名**: `image_path`
- **存储内容**: 仅文件名（如：`监控-1755326426046.jpg`）
- **存储位置**: `server/uploads/site-images/publishing-exception/`
- **访问URL**: `http://localhost:3001/files/site-images/publishing-exception/文件名`

### 存在的问题
1. **路径不完整**: 只保存文件名，前端无法直接构建访问URL
2. **不支持多文件**: 单一字段无法存储多个文件信息
3. **缺少元数据**: 没有原始文件名、文件大小、上传时间等信息
4. **扩展性差**: 难以支持不同类型的文件分类存储

## 新的存储格式设计

### 1. JSON对象格式存储

将 `image_path` 字段改为存储JSON格式的对象数组：

```json
[
  {
    "id": "file_1755326426046",
    "originalName": "监控图片.jpg",
    "filename": "监控-1755326426046.jpg",
    "relativePath": "site-images/publishing-exception/监控-1755326426046.jpg",
    "accessUrl": "/files/site-images/publishing-exception/监控-1755326426046.jpg",
    "fullUrl": "http://localhost:3001/files/site-images/publishing-exception/监控-1755326426046.jpg",
    "fileSize": 245760,
    "mimeType": "image/jpeg",
    "uploadTime": "2025-01-16T14:41:46.046Z",
    "fileType": "image",
    "category": "exception_evidence"
  }
]
```

### 2. 字段说明

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `id` | String | 文件唯一标识符 | `file_1755326426046` |
| `originalName` | String | 用户上传的原始文件名 | `监控图片.jpg` |
| `filename` | String | 服务器存储的文件名 | `监控-1755326426046.jpg` |
| `relativePath` | String | 相对于uploads目录的路径 | `site-images/publishing-exception/监控-1755326426046.jpg` |
| `accessUrl` | String | 前端访问的相对URL | `/files/site-images/publishing-exception/监控-1755326426046.jpg` |
| `fullUrl` | String | 完整的访问URL | `http://localhost:3001/files/site-images/publishing-exception/监控-1755326426046.jpg` |
| `fileSize` | Number | 文件大小（字节） | `245760` |
| `mimeType` | String | 文件MIME类型 | `image/jpeg` |
| `uploadTime` | String | 上传时间（ISO格式） | `2025-01-16T14:41:46.046Z` |
| `fileType` | String | 文件类型分类 | `image` |
| `category` | String | 文件业务分类 | `exception_evidence` |

### 3. 多文件支持示例

```json
[
  {
    "id": "file_1755326426046",
    "originalName": "异常现场图1.jpg",
    "filename": "异常现场图1-1755326426046.jpg",
    "relativePath": "site-images/publishing-exception/异常现场图1-1755326426046.jpg",
    "accessUrl": "/files/site-images/publishing-exception/异常现场图1-1755326426046.jpg",
    "fullUrl": "http://localhost:3001/files/site-images/publishing-exception/异常现场图1-1755326426046.jpg",
    "fileSize": 245760,
    "mimeType": "image/jpeg",
    "uploadTime": "2025-01-16T14:41:46.046Z",
    "fileType": "image",
    "category": "exception_evidence"
  },
  {
    "id": "file_1755326426123",
    "originalName": "异常现场图2.png",
    "filename": "异常现场图2-1755326426123.png",
    "relativePath": "site-images/publishing-exception/异常现场图2-1755326426123.png",
    "accessUrl": "/files/site-images/publishing-exception/异常现场图2-1755326426123.png",
    "fullUrl": "http://localhost:3001/files/site-images/publishing-exception/异常现场图2-1755326426123.png",
    "fileSize": 189432,
    "mimeType": "image/png",
    "uploadTime": "2025-01-16T14:41:46.123Z",
    "fileType": "image",
    "category": "exception_evidence"
  }
]
```

## 实现方案

### 1. 数据库字段调整
- 保持 `image_path` 字段名不变
- 字段类型：`NVARCHAR(MAX)` 或 `TEXT`
- 存储JSON格式的字符串

### 2. 后端修改
- 修改文件上传接口，返回完整的文件信息对象
- 修改保存逻辑，将文件信息对象序列化为JSON存储
- 修改查询逻辑，将JSON字符串解析为对象返回前端

### 3. 前端修改
- 修改文件上传组件，适配新的数据格式
- 实现图片预览和回显功能
- 支持多文件上传和管理

### 4. 兼容性处理
- 对于现有的旧数据（只有文件名），提供转换逻辑
- 在读取时检测数据格式，自动适配

## 优势

1. **完整路径信息**: 包含访问URL，前端可直接使用
2. **多文件支持**: 数组格式天然支持多个文件
3. **丰富元数据**: 包含文件大小、类型、上传时间等信息
4. **易于扩展**: JSON格式便于添加新字段
5. **向后兼容**: 可以处理现有的旧数据格式
6. **前端友好**: 直接提供可用的URL，无需额外拼接

## 迁移策略

1. **渐进式迁移**: 新数据使用新格式，旧数据保持兼容
2. **数据转换脚本**: 提供脚本将现有数据转换为新格式
3. **双格式支持**: 读取时同时支持新旧两种格式
4. **逐步清理**: 在确认新格式稳定后，逐步清理旧格式数据