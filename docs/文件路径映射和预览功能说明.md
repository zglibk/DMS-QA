# 文件路径映射和预览功能说明

## 🎯 **功能概述**

为解决跨网络设备获取图片或文件的困难，实现了文件路径映射和预览系统。该系统将网络路径"\\tj_server\工作\品质部\生产异常周报考核统计\2025年异常汇总"下的附件文件副本存储到服务器"D:\WebServer\backend\uploads\attachments\2025年异常汇总"路径下，并提供预览功能。

## 📋 **实现方案**

### 1. 导入时处理超链接
- **提取相对路径**：从Excel超链接中提取"2025年异常汇总\*"格式的相对路径
- **存储到数据库**：将相对路径存储到ComplaintRegister表的AttachmentFile字段
- **路径映射配置**：通过后台管理页面配置映射规则

### 2. 编辑/查看时回写路径
- **路径转换**：将数据库中的相对路径转换为服务器存储路径
- **文件预览**：通过HTTP API访问服务器副本进行预览
- **显示路径**：在界面中显示原始网络路径供用户参考

## 🔧 **技术实现**

### 后端实现

#### 1. 路径提取函数 (`server/routes/import.js`)
```javascript
// 提取相对路径函数 - 用于存储到数据库
function extractRelativePath(filePath) {
  // 检查是否包含"2025年异常汇总"
  const targetPattern = '2025年异常汇总';
  const targetIndex = filePath.indexOf(targetPattern);
  
  if (targetIndex !== -1) {
    // 提取从"2025年异常汇总"开始的相对路径
    const relativePath = filePath.substring(targetIndex);
    return relativePath;
  }
  
  return null;
}
```

#### 2. 附件文件API (`server/routes/complaint.js`)
```javascript
// 获取附件文件路径信息
router.get('/attachment-path/:id', async (req, res) => {
  // 将相对路径转换为服务器路径
  const serverPath = convertRelativePathToServerPath(attachmentFile);
  
  res.json({
    success: true,
    path: attachmentFile, // 原始相对路径
    displayPath: serverPath.displayPath, // 显示路径
    serverPath: serverPath.fullPath, // 服务器完整路径
    isAccessible: serverPath.isAccessible,
    type: 'relative_path'
  });
});

// 获取附件文件内容
router.get('/file/:id', async (req, res) => {
  // 通过文件流返回服务器副本
  const fileStream = fs.createReadStream(serverPath.fullPath);
  fileStream.pipe(res);
});
```

#### 3. 路径转换函数
```javascript
function convertRelativePathToServerPath(relativePath) {
  const baseServerPath = 'D:\\WebServer\\backend\\uploads\\attachments';
  const fullPath = path.join(baseServerPath, relativePath);
  const displayPath = `\\\\tj_server\\工作\\品质部\\生产异常周报考核统计\\${relativePath}`;
  
  return {
    fullPath: fullPath,
    displayPath: displayPath,
    isAccessible: fs.existsSync(fullPath)
  };
}
```

### 前端实现

#### 1. 附件查看器 (`frontend/src/components/AttachmentViewer.vue`)
- 获取附件路径信息
- 显示网络路径供用户参考
- 通过HTTP API预览服务器副本

#### 2. 图片预览服务 (`frontend/src/services/imagePreviewService.js`)
- 优先通过记录ID获取服务器副本
- 支持相对路径的图片预览
- 提供Blob URL用于图片显示

#### 3. 路径映射配置 (`frontend/src/components/admin/PathMappingConfig.vue`)
- 配置路径映射规则
- 支持多种映射模式
- 实时测试映射效果

## 📁 **路径映射规则**

### 默认映射配置
1. **Excel临时文件映射**
   - 本地模式：`C:\Users\*\AppData\Roaming\Microsoft\Excel\*`
   - 目标路径：`\\tj_server\工作\品质部\生产异常周报考核统计\*`

2. **2025年异常汇总映射**
   - 本地模式：`*2025年异常汇总\*`
   - 目标路径：`D:\WebServer\backend\uploads\attachments\2025年异常汇总\*`

3. **服务器存储映射**
   - 本地模式：`2025年异常汇总\*`
   - 目标路径：`D:\WebServer\backend\uploads\attachments\2025年异常汇总\*`

## 🔄 **工作流程**

### 导入流程
1. Excel文件包含超链接：`file:///C:\Users\TJ\AppData\Roaming\Microsoft\Excel\2025年异常汇总\01月份\不良图片\图片.jpg`
2. 提取相对路径：`2025年异常汇总\01月份\不良图片\图片.jpg`
3. 存储到数据库：AttachmentFile字段保存相对路径
4. 文件副本：手动拷贝到`D:\WebServer\backend\uploads\attachments\2025年异常汇总\01月份\不良图片\图片.jpg`

### 预览流程
1. 前端请求：`GET /api/complaint/attachment-path/123`
2. 后端返回：相对路径、显示路径、服务器路径、可访问性
3. 前端显示：网络路径供用户参考
4. 图片预览：`GET /api/complaint/file/123` 返回服务器副本

## 🎛️ **配置管理**

### 后台管理页面
- 路径：`/admin` → 系统配置 → 路径映射配置
- 功能：添加、编辑、删除映射规则
- 测试：实时测试路径转换效果

### 数据库表
- **PathMappingConfig**：存储路径映射规则
- **ComplaintRegister**：AttachmentFile字段存储相对路径

## 🔍 **使用说明**

### 管理员操作
1. 将网络路径下的附件文件拷贝到服务器存储路径
2. 通过后台管理页面配置路径映射规则
3. 测试路径映射是否正确工作

### 用户操作
1. 导入Excel文件时，系统自动提取相对路径
2. 查看投诉记录时，可预览服务器副本
3. 复制网络路径手动访问原始文件

## 🚀 **优势特点**

1. **跨网络访问**：解决不同网络环境下的文件访问问题
2. **自动映射**：导入时自动提取和转换路径
3. **双路径显示**：同时显示相对路径和网络路径
4. **服务器预览**：通过HTTP访问服务器副本
5. **配置灵活**：支持多种路径映射规则
6. **向后兼容**：保持现有功能不受影响

## 📝 **注意事项**

1. **文件同步**：需要手动将网络路径下的文件拷贝到服务器存储路径
2. **路径格式**：确保路径映射规则配置正确
3. **权限设置**：确保服务器对存储路径有读写权限
4. **存储空间**：注意服务器存储空间的使用情况
5. **文件更新**：网络路径下的文件更新时需要同步更新服务器副本

## 🔧 **故障排除**

### 常见问题
1. **图片无法预览**：检查服务器存储路径下是否有对应文件
2. **路径映射失效**：检查路径映射配置是否正确
3. **文件访问失败**：检查服务器权限和文件路径
4. **网络路径无法访问**：使用服务器副本进行预览

### 调试方法
1. 查看浏览器控制台日志
2. 检查后端服务器日志
3. 测试API接口响应
4. 验证文件路径存在性
