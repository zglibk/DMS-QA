# 材料单价自动填入功能说明

## 功能概述

在投诉记录新增和编辑对话框中，当用户选择材料名称时，系统会自动从材料价格数据库中获取对应的单价并填入单价字段，大大提高了数据录入的效率和准确性。

## 功能特点

### 1. 智能材料选择
- **下拉选择**：材料名称字段改为下拉选择框，显示所有可用的材料
- **支持搜索**：可以在下拉框中输入关键字快速搜索材料
- **支持新增**：如果需要的材料不在列表中，可以直接输入新的材料名称
- **实时加载**：材料列表从数据库实时获取，确保数据最新

### 2. 自动单价填入
- **即时获取**：选择材料后立即从数据库获取单价
- **智能缓存**：已查询过的材料单价会缓存，避免重复请求
- **多供应商支持**：如果材料有多个供应商，自动选择第一个有效价格
- **手动覆盖**：自动填入的单价可以手动修改

### 3. 用户体验优化
- **加载状态**：显示加载动画，提供良好的用户反馈
- **成功提示**：成功获取单价时显示确认消息
- **静默失败**：如果获取单价失败，不显示错误消息，允许用户手动输入

## 适用范围

### 投诉记录新增对话框
- 纸张名称 → 纸张单价
- 材料A名称 → 材料A单价
- 材料B名称 → 材料B单价
- 材料C名称 → 材料C单价

### 历史投诉记录编辑表单
- **通用字段**：所有材料字段都支持下拉选择和自动填入单价
- **材料明细模块**：在"材料明细"标签页的各个材料tab中也支持下拉选择
  - 纸张tab：纸张名称字段支持下拉选择和自动填入单价
  - 材料A tab：材料A名称字段支持下拉选择和自动填入单价
  - 材料B tab：材料B名称字段支持下拉选择和自动填入单价
  - 材料C tab：材料C名称字段支持下拉选择和自动填入单价
- 编辑时保持与新增相同的用户体验

## 使用方法

### 1. 新增投诉记录
1. 点击"新增投诉记录"按钮
2. 在表单中切换到"材料和成本"卡片
3. 选择相应的材料标签页（纸张、材料A、材料B、材料C）
4. 点击材料名称下拉框
5. 选择或输入材料名称
6. 系统自动填入对应的单价
7. 如需要，可以手动调整单价
8. 在"质量成本损失"卡片中可以查看和编辑人工成本、总成本

### 2. 编辑历史记录
1. 在投诉记录列表中点击"编辑"按钮
2. 在编辑对话框中找到材料名称字段：
   - **物料信息模块**：在物料信息模块中的材料名称字段
   - **材料明细模块**：切换到"材料明细"标签页，在各个材料tab中选择材料名称
   - **质量成本损失模块**：查看和编辑人工成本、总成本
3. 修改材料名称时会自动更新对应的单价
4. 保存修改

## 技术实现

### 后端API接口

#### 1. 获取材料名称列表
```
GET /api/admin/material-prices/material-names
```
- **功能**：获取所有有效的材料名称
- **返回**：材料名称数组
- **用途**：为前端下拉框提供数据源

#### 2. 获取材料单价
```
GET /api/admin/material-prices/get-price?materialName=材料名称&supplier=供应商
```
- **功能**：根据材料名称获取单价
- **参数**：
  - materialName（必填）：材料名称
  - supplier（可选）：供应商名称
- **返回**：单价信息对象或数组

#### 3. 获取供应商列表
```
GET /api/admin/material-prices/suppliers?materialName=材料名称
```
- **功能**：获取供应商列表
- **参数**：
  - materialName（可选）：材料名称
- **返回**：供应商名称数组

### 前端实现特点

#### 1. 组件优化
- 将材料名称输入框改为可搜索的下拉选择框
- 添加加载状态和用户反馈
- 实现缓存机制提高性能

#### 2. 数据流程
```
用户选择材料 → 检查缓存 → 调用API → 更新单价字段 → 显示成功消息
```

#### 3. 错误处理
- 网络错误：静默处理，不影响用户操作
- 数据不存在：记录日志，允许手动输入
- 权限问题：显示相应错误信息

## 数据来源

### MaterialPrice表结构
- **MaterialName**：材料名称
- **Supplier**：供应商
- **UnitPrice**：单价
- **IsActive**：是否有效
- **EffectiveDate**：生效日期
- **Version**：版本号

### 数据管理
- 通过"管理后台 → 供应商管理 → 材料价格管理"维护材料价格
- 支持价格历史记录和版本控制
- 支持Excel导入批量更新价格

## 注意事项

### 1. 数据准确性
- 确保材料价格表中的数据及时更新
- 定期检查和维护材料名称的标准化
- 注意价格的有效期管理

### 2. 性能考虑
- 材料名称列表会在组件加载时获取
- 单价查询结果会缓存在内存中
- 避免频繁的API调用

### 3. 用户培训
- 告知用户可以使用搜索功能快速找到材料
- 说明自动填入的单价可以手动修改
- 提醒用户及时更新材料价格数据

## 故障排除

### 1. 材料列表为空
- 检查材料价格表中是否有有效数据
- 确认IsActive字段为1
- 检查网络连接和API权限

### 2. 单价无法自动填入
- 确认材料名称在价格表中存在
- 检查UnitPrice字段是否为空
- 查看浏览器控制台的错误信息

### 3. 下拉框加载缓慢
- 检查数据库连接性能
- 考虑增加数据库索引
- 优化材料名称数据量

## 未来扩展

### 1. 供应商选择
- 支持在选择材料后进一步选择供应商
- 根据供应商显示不同的价格

### 2. 价格历史
- 显示材料的价格变化趋势
- 支持选择特定日期的价格

### 3. 批量操作
- 支持批量更新多个材料的单价
- 提供价格比较和分析功能

---

**版本**: v2.2.0  
**更新日期**: 2025年7月9日  
**维护者**: David Lee (zglibk)
