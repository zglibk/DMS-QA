# 🔍 系统日志管理设计方案

## 📊 概述

本方案旨在为DMS-QA系统设计完整的用户操作事务日志记录和管理功能，包括日志自动管理和手动管理功能，确保系统操作的可追溯性和安全性。

## 🗄️ 当前SystemLogs表结构分析

### 现有字段
```sql
CREATE TABLE [dbo].[SystemLogs] (
  [ID] INT IDENTITY(1,1) PRIMARY KEY,           -- 主键，自增ID
  [UserID] INT NOT NULL,                        -- 操作用户ID
  [Action] NVARCHAR(100) NOT NULL,              -- 操作类型
  [Details] NVARCHAR(1000),                     -- 操作详情
  [IPAddress] NVARCHAR(50),                     -- 操作IP地址
  [UserAgent] NVARCHAR(500),                    -- 用户代理
  [CreatedAt] DATETIME DEFAULT GETDATE(),       -- 创建时间
  [Status] NVARCHAR(20) DEFAULT 'SUCCESS',      -- 操作状态
  [ErrorMessage] NVARCHAR(1000),                -- 错误信息
)
```

### 需要扩展的字段
```sql
-- 建议添加的字段
ALTER TABLE [dbo].[SystemLogs] ADD
  [Category] NVARCHAR(50),                      -- 日志分类
  [Module] NVARCHAR(50),                        -- 所属模块
  [ResourceType] NVARCHAR(50),                  -- 资源类型
  [ResourceID] NVARCHAR(100),                   -- 资源ID
  [OperationType] NVARCHAR(20),                 -- 操作类型：CREATE/READ/UPDATE/DELETE
  [Severity] NVARCHAR(20) DEFAULT 'INFO',       -- 严重级别：DEBUG/INFO/WARN/ERROR/FATAL
  [Duration] INT,                               -- 操作耗时（毫秒）
  [RequestData] NVARCHAR(MAX),                  -- 请求数据（JSON格式）
  [ResponseData] NVARCHAR(MAX),                 -- 响应数据（JSON格式）
  [SessionID] NVARCHAR(100),                    -- 会话ID
  [TraceID] NVARCHAR(100);                      -- 链路追踪ID
```

## 📋 日志分类体系设计

### 1. 🔐 认证授权类 (AUTH)

#### 登录相关
- **LOGIN_SUCCESS**: 用户登录成功
- **LOGIN_FAILED**: 用户登录失败
- **LOGOUT**: 用户登出
- **SESSION_EXPIRED**: 会话过期
- **CAPTCHA_VERIFY**: 验证码验证

#### 权限相关
- **PERMISSION_GRANT**: 权限授予
- **PERMISSION_REVOKE**: 权限撤销
- **PERMISSION_REFRESH**: 权限刷新
- **ROLE_ASSIGN**: 角色分配
- **ROLE_REMOVE**: 角色移除

### 2. 👥 用户管理类 (USER_MGMT)

#### 用户操作
- **USER_CREATE**: 创建用户
- **USER_UPDATE**: 更新用户信息
- **USER_DELETE**: 删除用户
- **USER_ENABLE**: 启用用户
- **USER_DISABLE**: 禁用用户
- **PASSWORD_CHANGE**: 密码修改
- **PASSWORD_RESET**: 密码重置

#### 角色管理
- **ROLE_CREATE**: 创建角色
- **ROLE_UPDATE**: 更新角色
- **ROLE_DELETE**: 删除角色
- **ROLE_PERMISSION_UPDATE**: 角色权限更新

### 3. 📊 数据操作类 (DATA_OPS)

#### 投诉管理
- **COMPLAINT_CREATE**: 创建投诉
- **COMPLAINT_UPDATE**: 更新投诉
- **COMPLAINT_DELETE**: 删除投诉
- **COMPLAINT_STATUS_CHANGE**: 投诉状态变更
- **COMPLAINT_ASSIGN**: 投诉分配

#### 质量管理
- **QUALITY_METRIC_CREATE**: 创建质量指标
- **QUALITY_METRIC_UPDATE**: 更新质量指标
- **QUALITY_TARGET_SET**: 设置质量目标
- **REWORK_RECORD_CREATE**: 创建返工记录

#### 工作计划
- **WORK_PLAN_CREATE**: 创建工作计划
- **WORK_PLAN_UPDATE**: 更新工作计划
- **WORK_PLAN_DELETE**: 删除工作计划
- **WORK_LOG_CREATE**: 创建工作日志
- **MILESTONE_CREATE**: 创建里程碑

### 4. 📁 文件操作类 (FILE_OPS)

#### 文件管理
- **FILE_UPLOAD**: 文件上传
- **FILE_DOWNLOAD**: 文件下载
- **FILE_DELETE**: 文件删除
- **FILE_SHARE**: 文件分享
- **FILE_PREVIEW**: 文件预览

#### 附件操作
- **ATTACHMENT_ADD**: 添加附件
- **ATTACHMENT_REMOVE**: 移除附件
- **ATTACHMENT_DOWNLOAD**: 下载附件

### 5. ⚙️ 系统配置类 (SYS_CONFIG)

#### 配置管理
- **CONFIG_UPDATE**: 配置更新
- **MENU_CREATE**: 创建菜单
- **MENU_UPDATE**: 更新菜单
- **MENU_DELETE**: 删除菜单
- **DEPARTMENT_CREATE**: 创建部门
- **DEPARTMENT_UPDATE**: 更新部门

#### ERP集成
- **ERP_SYNC_START**: ERP同步开始
- **ERP_SYNC_SUCCESS**: ERP同步成功
- **ERP_SYNC_FAILED**: ERP同步失败
- **ERP_CONFIG_UPDATE**: ERP配置更新

### 6. 📈 数据导入导出类 (DATA_TRANSFER)

#### 导入操作
- **DATA_IMPORT_START**: 数据导入开始
- **DATA_IMPORT_SUCCESS**: 数据导入成功
- **DATA_IMPORT_FAILED**: 数据导入失败
- **TEMPLATE_DOWNLOAD**: 模板下载

#### 导出操作
- **DATA_EXPORT**: 数据导出
- **REPORT_GENERATE**: 报表生成
- **EXCEL_EXPORT**: Excel导出
- **PDF_EXPORT**: PDF导出

### 7. 🔍 查询统计类 (QUERY_STATS)

#### 数据查询
- **DATA_QUERY**: 数据查询
- **REPORT_VIEW**: 报表查看
- **STATISTICS_VIEW**: 统计查看
- **DASHBOARD_ACCESS**: 仪表盘访问

### 8. ⚠️ 系统异常类 (SYS_ERROR)

#### 错误处理
- **API_ERROR**: API错误
- **DATABASE_ERROR**: 数据库错误
- **NETWORK_ERROR**: 网络错误
- **PERMISSION_DENIED**: 权限拒绝
- **RESOURCE_NOT_FOUND**: 资源未找到

## 🔧 日志记录实现方案

### 1. 统一日志记录工具类

```javascript
/**
 * 系统日志记录工具类
 * 提供统一的日志记录接口
 */
class SystemLogger {
  /**
   * 记录系统日志
   * @param {Object} logData - 日志数据
   */
  static async log(logData) {
    const {
      userId,
      action,
      category,
      module,
      details,
      resourceType,
      resourceId,
      operationType,
      severity = 'INFO',
      status = 'SUCCESS',
      errorMessage,
      ipAddress,
      userAgent,
      sessionId,
      traceId,
      duration,
      requestData,
      responseData
    } = logData;

    // 实现日志记录逻辑
  }
}
```

### 2. 中间件集成

```javascript
/**
 * Express中间件：自动记录API请求日志
 */
function apiLoggerMiddleware(req, res, next) {
  const startTime = Date.now();
  
  // 记录请求开始
  const originalSend = res.send;
  res.send = function(data) {
    const duration = Date.now() - startTime;
    
    // 记录API调用日志
    SystemLogger.log({
      userId: req.user?.id,
      action: `API_${req.method}_${req.route?.path}`,
      category: 'API_CALL',
      module: getModuleFromPath(req.path),
      details: `${req.method} ${req.originalUrl}`,
      operationType: req.method,
      severity: res.statusCode >= 400 ? 'ERROR' : 'INFO',
      status: res.statusCode >= 400 ? 'FAILED' : 'SUCCESS',
      ipAddress: req.ip,
      userAgent: req.get('User-Agent'),
      duration,
      requestData: JSON.stringify(req.body),
      responseData: typeof data === 'string' ? data : JSON.stringify(data)
    });
    
    originalSend.call(this, data);
  };
  
  next();
}
```

## 📊 日志管理功能设计

### 1. 日志查询API

```javascript
// GET /api/system-logs
// 支持的查询参数：
// - page, pageSize: 分页
// - category: 日志分类
// - module: 模块
// - userId: 用户ID
// - action: 操作类型
// - severity: 严重级别
// - status: 操作状态
// - startDate, endDate: 时间范围
// - keyword: 关键词搜索
```

### 2. 日志统计API

```javascript
// GET /api/system-logs/statistics
// 返回数据：
// - 按分类统计
// - 按用户统计
// - 按时间统计
// - 错误率统计
// - 操作频率统计
```

### 3. 日志导出API

```javascript
// POST /api/system-logs/export
// 支持格式：Excel, CSV, JSON
// 支持筛选条件导出
```

## 🔄 自动日志管理

### 1. 日志清理策略

```javascript
/**
 * 日志自动清理配置
 */
const LOG_CLEANUP_CONFIG = {
  // 按时间清理
  retention: {
    DEBUG: 7,      // DEBUG日志保留7天
    INFO: 30,      // INFO日志保留30天
    WARN: 90,      // WARN日志保留90天
    ERROR: 365,    // ERROR日志保留1年
    FATAL: -1      // FATAL日志永久保留
  },
  
  // 按大小清理
  maxSize: {
    total: '10GB',     // 总日志大小限制
    single: '100MB'    // 单个日志文件大小限制
  },
  
  // 清理频率
  schedule: '0 2 * * *'  // 每天凌晨2点执行清理
};
```

### 2. 日志归档策略

```javascript
/**
 * 日志归档配置
 */
const LOG_ARCHIVE_CONFIG = {
  // 归档条件
  archiveAfter: 90,      // 90天后归档
  
  // 归档格式
  format: 'compressed',   // 压缩格式
  
  // 归档位置
  location: 'archive/',   // 归档目录
  
  // 归档频率
  schedule: '0 1 * * 0'   // 每周日凌晨1点执行归档
};
```

## 🎯 日志监控和告警

### 1. 异常检测规则

```javascript
/**
 * 异常检测配置
 */
const ALERT_RULES = {
  // 登录失败次数过多
  loginFailure: {
    threshold: 5,          // 5次失败
    timeWindow: 300,       // 5分钟内
    action: 'LOCK_ACCOUNT' // 锁定账户
  },
  
  // 权限异常操作
  permissionAnomaly: {
    threshold: 10,         // 10次权限拒绝
    timeWindow: 600,       // 10分钟内
    action: 'ALERT_ADMIN'  // 通知管理员
  },
  
  // 系统错误率过高
  errorRate: {
    threshold: 0.1,        // 错误率10%
    timeWindow: 300,       // 5分钟内
    action: 'SYSTEM_ALERT' // 系统告警
  }
};
```

### 2. 告警通知方式

- **邮件通知**: 发送告警邮件给管理员
- **系统通知**: 在系统内显示告警消息
- **日志记录**: 记录告警事件到专门的告警日志

## 🎨 前端日志管理界面

### 1. 日志查看页面

- **列表展示**: 分页显示日志列表
- **高级筛选**: 多条件组合筛选
- **实时刷新**: 支持实时查看最新日志
- **详情查看**: 点击查看日志详细信息

### 2. 日志统计页面

- **图表展示**: 使用ECharts展示统计数据
- **时间维度**: 按小时、天、周、月统计
- **分类统计**: 按日志分类、用户、模块统计
- **趋势分析**: 显示日志趋势变化

### 3. 日志管理页面

- **批量操作**: 支持批量删除、导出
- **清理配置**: 配置自动清理规则
- **归档管理**: 管理归档日志
- **告警配置**: 配置监控告警规则

## 📝 实施计划

### 第一阶段：基础功能 (1周)
1. 扩展SystemLogs表结构
2. 创建SystemLogger工具类
3. 实现基础日志记录功能
4. 创建日志查询API

### 第二阶段：全面集成 (1周)
1. 在各业务模块中集成日志记录
2. 实现API中间件自动记录
3. 创建日志统计和导出功能
4. 开发前端日志查看界面

### 第三阶段：高级功能 (1周)
1. 实现日志自动清理功能
2. 开发日志监控告警系统
3. 创建日志管理界面
4. 性能优化和测试

### 第四阶段：完善优化 (0.5周)
1. 用户体验优化
2. 文档完善
3. 部署和上线
4. 培训和支持

## 🔒 安全考虑

### 1. 敏感信息保护
- 密码等敏感信息不记录到日志
- 个人隐私信息脱敏处理
- 日志访问权限控制

### 2. 日志完整性
- 日志不可篡改机制
- 日志备份和恢复
- 审计日志的审计

### 3. 性能影响
- 异步日志记录
- 批量写入优化
- 索引优化查询性能

## 📊 预期效果

1. **操作可追溯**: 所有用户操作都有完整的日志记录
2. **安全监控**: 及时发现和处理安全异常
3. **性能分析**: 通过日志分析系统性能瓶颈
4. **合规审计**: 满足合规要求的审计需求
5. **故障排查**: 快速定位和解决系统问题

通过实施这套完整的系统日志管理方案，将大大提升DMS-QA系统的可维护性、安全性和可靠性。