# è½¬æ¢è®¾ç½®å¼€å…³ä¿å­˜ä¿®å¤éªŒè¯

## ğŸ› **é—®é¢˜æè¿°**

è½¬æ¢è®¾ç½®æ¨¡å—ä¸­çš„å„é¡¹åŠŸèƒ½å¼€å…³è®¾ç½®ï¼ˆswitchï¼‰åœ¨ä¿å­˜é…ç½®åï¼Œåˆ·æ–°ç½‘é¡µåˆæ¢å¤åˆ°åŸæ¥çš„å¼€å¯çŠ¶æ€ï¼Œæ— æ³•æŒä¹…åŒ–ä¿å­˜ã€‚

## ğŸ” **é—®é¢˜åˆ†æ**

### æ ¹æœ¬åŸå› 
1. **åç«¯GET APIç¼ºå¤±è½¬æ¢é…ç½®**ï¼š`GET /api/import/path-mapping-config` æ²¡æœ‰è¿”å› `conversionConfig`
2. **å‰ç«¯æœªåŠ è½½è½¬æ¢é…ç½®**ï¼š`loadConfig()` å‡½æ•°åªåŠ è½½äº† `pathMappings`ï¼Œå¿½ç•¥äº† `conversionConfig`
3. **æ•°æ®åº“è¡¨ç¼ºå¤±**ï¼šæ²¡æœ‰ `ConversionConfig` è¡¨æ¥å­˜å‚¨è½¬æ¢é…ç½®
4. **ä¿å­˜é€»è¾‘ä¸å®Œæ•´**ï¼šPUT APIæ¥æ”¶äº† `conversionConfig` ä½†æ²¡æœ‰ä¿å­˜åˆ°æ•°æ®åº“

## ğŸ› ï¸ **ä¿®å¤æ–¹æ¡ˆ**

### 1. åˆ›å»ºConversionConfigæ•°æ®åº“è¡¨

```sql
-- è½¬æ¢é…ç½®è¡¨
CREATE TABLE [dbo].[ConversionConfig] (
    [ID] INT IDENTITY(1,1) PRIMARY KEY,
    [ConfigKey] NVARCHAR(50) NOT NULL UNIQUE,
    [ConfigValue] NVARCHAR(500),
    [Description] NVARCHAR(200),
    [CreatedAt] DATETIME DEFAULT GETDATE(),
    [UpdatedAt] DATETIME DEFAULT GETDATE()
);

-- æ’å…¥é»˜è®¤è½¬æ¢é…ç½®
INSERT INTO [dbo].[ConversionConfig] ([ConfigKey], [ConfigValue], [Description]) VALUES
(N'autoConvert', N'true', N'å¯ç”¨è‡ªåŠ¨è½¬æ¢'),
(N'keepOriginal', N'false', N'ä¿ç•™åŸå§‹è·¯å¾„'),
(N'fileCopyMode', N'true', N'å¯ç”¨æ–‡ä»¶æ‹·è´æ¨¡å¼'),
(N'validatePaths', N'false', N'è·¯å¾„éªŒè¯');
```

### 2. ä¿®å¤åç«¯GET API

```javascript
// ä»æ•°æ®åº“åŠ è½½è½¬æ¢é…ç½®
let conversionConfig = {
  autoConvert: true,
  keepOriginal: false,
  fileCopyMode: true,
  validatePaths: false
};

try {
  const configResult = await connection.request()
    .query('SELECT ConfigKey, ConfigValue FROM ConversionConfig');
  
  // å°†æ•°æ®åº“ç»“æœè½¬æ¢ä¸ºå¯¹è±¡
  configResult.recordset.forEach(row => {
    const key = row.ConfigKey;
    const value = row.ConfigValue;
    
    // è½¬æ¢å­—ç¬¦ä¸²å€¼ä¸ºå¸ƒå°”å€¼
    if (value === 'true' || value === 'false') {
      conversionConfig[key] = value === 'true';
    } else {
      conversionConfig[key] = value;
    }
  });
  
  console.log('ä»æ•°æ®åº“åŠ è½½è½¬æ¢é…ç½®:', conversionConfig);
} catch (dbError) {
  console.log('æ•°æ®åº“æŸ¥è¯¢è½¬æ¢é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', dbError.message);
}

// åœ¨è¿”å›çš„configä¸­åŒ…å«conversionConfig
const config = {
  // ... å…¶ä»–é…ç½®
  conversionConfig: conversionConfig,
  // ...
};
```

### 3. ä¿®å¤åç«¯PUT API

```javascript
// ä¿å­˜è½¬æ¢é…ç½®
if (conversionConfig && typeof conversionConfig === 'object') {
  console.log('ä¿å­˜è½¬æ¢é…ç½®:', conversionConfig);
  
  for (const [key, value] of Object.entries(conversionConfig)) {
    const stringValue = String(value);
    
    // æ£€æŸ¥é…ç½®é¡¹æ˜¯å¦å­˜åœ¨
    const existingConfigResult = await transaction.request()
      .input('ConfigKey', sql.NVarChar, key)
      .query('SELECT ID FROM ConversionConfig WHERE ConfigKey = @ConfigKey');
    
    if (existingConfigResult.recordset.length > 0) {
      // æ›´æ–°ç°æœ‰é…ç½®
      await transaction.request()
        .input('ConfigKey', sql.NVarChar, key)
        .input('ConfigValue', sql.NVarChar, stringValue)
        .query(`UPDATE ConversionConfig SET 
                  ConfigValue = @ConfigValue, 
                  UpdatedAt = GETDATE() 
                WHERE ConfigKey = @ConfigKey`);
    } else {
      // æ’å…¥æ–°é…ç½®
      await transaction.request()
        .input('ConfigKey', sql.NVarChar, key)
        .input('ConfigValue', sql.NVarChar, stringValue)
        .input('Description', sql.NVarChar, `è½¬æ¢é…ç½®é¡¹: ${key}`)
        .query(`INSERT INTO ConversionConfig (ConfigKey, ConfigValue, Description, CreatedAt, UpdatedAt)
                VALUES (@ConfigKey, @ConfigValue, @Description, GETDATE(), GETDATE())`);
    }
  }
}
```

### 4. ä¿®å¤å‰ç«¯loadConfigå‡½æ•°

```javascript
// åŠ è½½è½¬æ¢é…ç½®
if (config.conversionConfig) {
  console.log('åŠ è½½è½¬æ¢é…ç½®:', config.conversionConfig)
  Object.assign(conversionConfig, config.conversionConfig)
}
```

## âœ… **ä¿®å¤éªŒè¯**

### APIæµ‹è¯•ç»“æœ

#### 1. GETè¯·æ±‚æµ‹è¯•
```bash
curl -X GET http://localhost:3001/api/import/path-mapping-config
```

**è¿”å›ç»“æœ**ï¼š
```json
{
  "success": true,
  "data": {
    "conversionConfig": {
      "autoConvert": true,
      "keepOriginal": false,
      "fileCopyMode": true,
      "validatePaths": false
    }
  }
}
```

#### 2. PUTè¯·æ±‚æµ‹è¯•
```bash
curl -X PUT http://localhost:3001/api/import/path-mapping-config \
  -H "Content-Type: application/json" \
  -d '{
    "conversionConfig": {
      "autoConvert": false,
      "keepOriginal": true,
      "fileCopyMode": false,
      "validatePaths": true
    }
  }'
```

**è¿”å›ç»“æœ**ï¼š
```json
{
  "success": true,
  "message": "è·¯å¾„æ˜ å°„é…ç½®ä¿å­˜æˆåŠŸ",
  "data": {
    "conversionConfig": {
      "autoConvert": false,
      "keepOriginal": true,
      "fileCopyMode": false,
      "validatePaths": true
    }
  }
}
```

#### 3. éªŒè¯ä¿å­˜ç»“æœ
å†æ¬¡GETè¯·æ±‚ï¼Œç¡®è®¤é…ç½®å·²æŒä¹…åŒ–ï¼š
```json
{
  "conversionConfig": {
    "autoConvert": false,    // âœ… å·²æ›´æ–°
    "keepOriginal": true,    // âœ… å·²æ›´æ–°
    "fileCopyMode": false,   // âœ… å·²æ›´æ–°
    "validatePaths": true    // âœ… å·²æ›´æ–°
  }
}
```

## ğŸ¯ **åŠŸèƒ½ç‰¹ç‚¹**

### âœ… å®Œæ•´çš„CRUDæ“ä½œ
- **è¯»å–**ï¼šä»æ•°æ®åº“åŠ è½½è½¬æ¢é…ç½®
- **æ›´æ–°**ï¼šä¿å­˜ä¿®æ”¹åçš„é…ç½®åˆ°æ•°æ®åº“
- **æ’å…¥**ï¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„é…ç½®é¡¹
- **é»˜è®¤å€¼**ï¼šæä¾›åˆç†çš„é»˜è®¤é…ç½®

### âœ… æ•°æ®ç±»å‹å¤„ç†
- **å¸ƒå°”å€¼è½¬æ¢**ï¼šå­—ç¬¦ä¸² 'true'/'false' â†” å¸ƒå°”å€¼ true/false
- **ç±»å‹å®‰å…¨**ï¼šç¡®ä¿æ•°æ®ç±»å‹æ­£ç¡®è½¬æ¢
- **å®¹é”™å¤„ç†**ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤é…ç½®

### âœ… äº‹åŠ¡å®‰å…¨
- **åŸå­æ“ä½œ**ï¼šæ‰€æœ‰é…ç½®æ›´æ–°åœ¨åŒä¸€äº‹åŠ¡ä¸­
- **å›æ»šæœºåˆ¶**ï¼šå¤±è´¥æ—¶è‡ªåŠ¨å›æ»šæ‰€æœ‰æ›´æ”¹
- **ä¸€è‡´æ€§ä¿è¯**ï¼šç¡®ä¿æ•°æ®å®Œæ•´æ€§

### âœ… å‰ç«¯é›†æˆ
- **è‡ªåŠ¨åŠ è½½**ï¼šé¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–æœ€æ–°é…ç½®
- **å®æ—¶æ›´æ–°**ï¼šä¿å­˜åç«‹å³åæ˜ åœ¨ç•Œé¢ä¸Š
- **çŠ¶æ€åŒæ­¥**ï¼šå‰ç«¯çŠ¶æ€ä¸æ•°æ®åº“ä¿æŒä¸€è‡´

## ğŸ“‹ **æµ‹è¯•æ¸…å•**

### âœ… åç«¯APIæµ‹è¯•
- [x] GETæ¥å£è¿”å›è½¬æ¢é…ç½®
- [x] PUTæ¥å£ä¿å­˜è½¬æ¢é…ç½®
- [x] æ•°æ®åº“æ­£ç¡®å­˜å‚¨é…ç½®
- [x] é…ç½®æŒä¹…åŒ–éªŒè¯

### âœ… å‰ç«¯åŠŸèƒ½æµ‹è¯•
- [x] é¡µé¢åŠ è½½æ—¶æ­£ç¡®æ˜¾ç¤ºé…ç½®
- [x] å¼€å…³åˆ‡æ¢åŠŸèƒ½æ­£å¸¸
- [x] ä¿å­˜é…ç½®æˆåŠŸ
- [x] åˆ·æ–°é¡µé¢åé…ç½®ä¿æŒ

### âœ… æ•°æ®å®Œæ•´æ€§æµ‹è¯•
- [x] å¸ƒå°”å€¼æ­£ç¡®è½¬æ¢
- [x] é»˜è®¤é…ç½®æ­£ç¡®åŠ è½½
- [x] å¼‚å¸¸æƒ…å†µå¤„ç†
- [x] äº‹åŠ¡å›æ»šæœºåˆ¶

## ğŸ‰ **ä¿®å¤æ€»ç»“**

é€šè¿‡ä»¥ä¸‹ä¿®å¤æªæ–½ï¼Œè½¬æ¢è®¾ç½®å¼€å…³çš„ä¿å­˜é—®é¢˜å·²å®Œå…¨è§£å†³ï¼š

1. **æ•°æ®åº“å±‚é¢**ï¼šåˆ›å»ºConversionConfigè¡¨å­˜å‚¨é…ç½®
2. **åç«¯API**ï¼šå®Œå–„GET/PUTæ¥å£çš„è½¬æ¢é…ç½®å¤„ç†
3. **å‰ç«¯é€»è¾‘**ï¼šä¿®å¤loadConfigå‡½æ•°åŠ è½½è½¬æ¢é…ç½®
4. **æ•°æ®åŒæ­¥**ï¼šç¡®ä¿å‰åç«¯é…ç½®çŠ¶æ€ä¸€è‡´

ç°åœ¨ç”¨æˆ·å¯ä»¥ï¼š
- âœ… æ­£å¸¸åˆ‡æ¢è½¬æ¢è®¾ç½®å¼€å…³
- âœ… ä¿å­˜é…ç½®åˆ°æ•°æ®åº“
- âœ… åˆ·æ–°é¡µé¢åé…ç½®ä¿æŒä¸å˜
- âœ… äº«å—å®Œæ•´çš„é…ç½®ç®¡ç†åŠŸèƒ½

è½¬æ¢è®¾ç½®æ¨¡å—çš„æ‰€æœ‰åŠŸèƒ½ç°åœ¨éƒ½èƒ½æ­£å¸¸å·¥ä½œï¼Œç”¨æˆ·ä½“éªŒå¾—åˆ°æ˜¾è‘—æ”¹å–„ï¼
