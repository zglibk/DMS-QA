# 主责人考核自动计算功能说明

## 📋 功能概述

在投诉记录新增和编辑对话框中实现了主责人考核金额的自动计算功能。系统会根据总成本自动计算主责人考核金额，确保考核金额的准确性和一致性。

## 🔧 计算规则

### 计算公式
```
主责人考核金额 = 总成本 × 50%
```

### 特殊规则
1. **前提条件**：总成本 > 0
2. **最低金额**：如果计算结果不足20元，则计为20元
3. **零值处理**：如果总成本 ≤ 0，则主责人考核金额为0

### 计算逻辑流程
```javascript
if (总成本 <= 0) {
  主责人考核金额 = 0
} else {
  主责人考核金额 = 总成本 × 50%
  if (主责人考核金额 < 20) {
    主责人考核金额 = 20
  }
}
```

## 📊 计算示例

### 示例1：正常计算
- **总成本**：100元
- **计算过程**：100 × 50% = 50元
- **结果**：50元（≥20元，无需调整）

### 示例2：最低金额调整
- **总成本**：30元
- **计算过程**：30 × 50% = 15元
- **结果**：20元（<20元，调整为20元）

### 示例3：零值处理
- **总成本**：0元
- **计算过程**：总成本≤0
- **结果**：0元

### 示例4：大额计算
- **总成本**：1000元
- **计算过程**：1000 × 50% = 500元
- **结果**：500元

## 🎯 功能特点

### 1. 自动触发计算
- **总成本变化时**：总成本更新后自动计算主责人考核金额
- **实时更新**：使用Vue监听器实现实时计算
- **级联计算**：总成本计算完成后自动触发主责人考核计算

### 2. 智能规则处理
- **最低金额保障**：确保考核金额不低于20元（当总成本>0时）
- **零值合理处理**：总成本为0时考核金额也为0
- **精度控制**：四舍五入到2位小数

### 3. 完善的日志记录
- **详细计算过程**：控制台输出完整的计算过程
- **规则说明**：显示适用的计算规则
- **结果验证**：便于调试和验证计算结果

## 📋 适用范围

### 1. 新增投诉记录对话框
- **触发条件**：总成本发生变化
- **显示位置**：责任与考核模块的"主责人考核"字段
- **计算函数**：`calculateMainPersonAssessment()`

### 2. 历史投诉记录编辑对话框
- **触发条件**：编辑表单中总成本发生变化
- **显示位置**：责任与考核模块的"主责人考核"字段
- **计算函数**：`calculateEditMainPersonAssessment()`

## 🔧 技术实现

### 新增投诉记录对话框 (`ComplaintFormDialog.vue`)

#### 计算函数
```javascript
const calculateMainPersonAssessment = () => {
  const totalCost = Number(form.value.TotalCost) || 0;
  
  // 如果总成本为0或负数，主责人考核金额为0
  if (totalCost <= 0) {
    form.value.MainPersonAssessment = 0;
    return;
  }
  
  // 计算主责人考核金额：总成本 × 50%
  let assessmentAmount = totalCost * 0.5;
  
  // 如果考核金额不足20元，则计为20元
  if (assessmentAmount < 20) {
    assessmentAmount = 20;
  }
  
  // 四舍五入到2位小数
  form.value.MainPersonAssessment = Math.round(assessmentAmount * 100) / 100;
}
```

#### 监听器
```javascript
// 主责人考核自动计算
watch(() => form.value.TotalCost, (totalCost) => {
  console.log('主责人考核监听器触发:', totalCost);
  calculateMainPersonAssessment();
})
```

#### 级联触发
```javascript
const calculateTotalCost = () => {
  // ... 总成本计算逻辑
  
  // 总成本变化后，触发主责人考核计算
  calculateMainPersonAssessment();
}
```

### 历史记录编辑对话框 (`Home.vue`)

#### 计算函数
```javascript
const calculateEditMainPersonAssessment = () => {
  if (!editFormData.value) return;
  
  const totalCost = Number(editFormData.value.TotalCost) || 0;
  
  // 相同的计算逻辑...
  editFormData.value.MainPersonAssessment = Math.round(assessmentAmount * 100) / 100;
}
```

#### 监听器
```javascript
// 监听编辑表单总成本变化，自动计算主责人考核
watch(() => editFormData.value ? editFormData.value.TotalCost : 0, (totalCost) => {
  console.log('编辑表单主责人考核监听器触发:', totalCost);
  if (editFormData.value) {
    calculateEditMainPersonAssessment();
  }
})
```

## 🎉 使用方法

### 1. 新增投诉记录
1. 打开"新增投诉记录"对话框
2. 输入材料信息和成本数据
3. 系统自动计算总成本
4. 系统自动计算主责人考核金额
5. 在"责任与考核"模块中查看计算结果

### 2. 编辑历史记录
1. 点击投诉记录的"编辑"按钮
2. 修改任何影响总成本的字段
3. 系统自动重新计算总成本
4. 系统自动重新计算主责人考核金额
5. 在"责任与考核"模块中查看更新结果

## 📈 计算流程图

```
材料成本变化 → 总成本重新计算 → 主责人考核重新计算
     ↓                ↓                    ↓
人工成本变化 → 总成本更新完成 → 主责人考核更新完成
```

## 🔍 调试信息

### 控制台日志示例
```
总成本计算: 纸张=320, 材料A=135, 材料B=40, 材料C=19.2, 人工=140, 总计=654.2元
主责人考核监听器触发: 654.2
主责人考核计算: 总成本=654.2元, 考核金额=327.1元 (654.2×50%=327.1, 最低20元)
```

### 特殊情况日志
```
// 总成本为0的情况
主责人考核计算: 总成本=0元, 考核金额=0元 (总成本≤0)

// 最低金额调整的情况
主责人考核计算: 总成本=30元, 考核金额=20元 (30×50%=15, 最低20元)
```

## 🔮 未来扩展

### 1. 考核规则配置化
- 将50%的比例设置为可配置参数
- 将20元的最低金额设置为可配置参数
- 支持不同类型投诉的不同考核比例

### 2. 多级考核计算
- 支持次责人考核金额计算
- 支持管理者考核金额计算
- 支持考核金额分配规则

### 3. 考核历史记录
- 记录考核金额的计算历史
- 提供考核金额变化趋势分析
- 支持考核数据统计报表

### 4. 考核审批流程
- 支持考核金额的审批流程
- 提供考核金额调整功能
- 记录考核金额的审批历史

## 📝 相关文件

### 前端文件
- `frontend/src/components/ComplaintFormDialog.vue` - 新增投诉记录对话框
- `frontend/src/views/Home.vue` - 历史记录编辑对话框

### 数据库字段
- `MainPersonAssessment` - 主责人考核字段（decimal类型）
- `TotalCost` - 总成本字段（decimal类型）

### 相关功能
- 总成本自动计算功能
- 人工成本自动计算功能
- 材料单价自动填入功能

## 🎊 总结

主责人考核自动计算功能已完成，特点包括：

1. ✅ **准确计算**：严格按照业务规则计算考核金额
2. ✅ **自动触发**：总成本变化时自动重新计算
3. ✅ **规则完善**：包含最低金额保障和零值处理
4. ✅ **实时更新**：使用Vue监听器实现实时计算
5. ✅ **调试友好**：详细的计算过程日志
6. ✅ **双对话框支持**：新增和编辑对话框完全支持

该功能确保了主责人考核金额的准确性和一致性，为质量管理提供了可靠的考核依据。

---

**功能开发时间**: 2025年7月9日  
**开发者**: David Lee (zglibk)  
**版本**: v2.2.5
