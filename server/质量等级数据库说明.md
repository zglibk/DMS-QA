# 质量等级数据库说明

## 概述

质量等级功能使用专门的数据库表 `QualityLevelSettings` 来保存质量等级配置数据。这确保了数据的持久化存储和系统的稳定性。

## 数据库表结构

### QualityLevelSettings 表

| 字段名 | 数据类型 | 说明 | 约束 |
|--------|----------|------|------|
| ID | INT IDENTITY(1,1) | 主键，自增ID | PRIMARY KEY |
| Grade | NVARCHAR(10) | 质量等级（如A、B、C、D） | NOT NULL, UNIQUE |
| Title | NVARCHAR(50) | 等级名称（如优秀、良好等） | NOT NULL |
| Description | NVARCHAR(200) | 等级描述 | NOT NULL |
| Range | NVARCHAR(100) | 适用范围（如合格率范围） | NOT NULL |
| CreatedAt | DATETIME | 创建时间 | DEFAULT GETDATE() |
| UpdatedAt | DATETIME | 更新时间 | DEFAULT GETDATE() |

### 索引

- `IX_QualityLevelSettings_Grade`: 在 Grade 字段上的唯一索引，用于优化查询性能

## 数据初始化

### 默认质量等级数据

系统会自动插入以下默认质量等级数据：

| 等级 | 名称 | 描述 | 范围 |
|------|------|------|------|
| A | 优秀 | 产品质量完全符合标准，无任何缺陷 | 合格率 ≥ 99% |
| B | 良好 | 产品质量基本符合标准，存在轻微缺陷 | 合格率 95-99% |
| C | 一般 | 产品质量勉强符合标准，存在明显缺陷 | 合格率 90-95% |
| D | 不合格 | 产品质量不符合标准，存在严重缺陷 | 合格率 < 90% |

## 数据库文件位置

### 1. 主初始化脚本
- **文件**: `server/init.sql`
- **位置**: 第771-800行
- **用途**: 新系统部署时自动创建表和初始化数据

### 2. 独立创建脚本
- **文件**: `server/create_quality_level_settings_table.sql`
- **用途**: 现有系统升级时单独执行的脚本
- **特点**: 包含表存在性检查，避免重复创建

## API 接口

### 后端路由文件
- **文件**: `server/routes/rework.js`
- **相关接口**:
  - `GET /api/rework/quality-levels` - 获取质量等级列表
  - `PUT /api/rework/quality-levels/batch` - 批量更新质量等级
  - `POST /api/rework/quality-levels` - 新增质量等级
  - `DELETE /api/rework/quality-levels/:id` - 删除质量等级

## 数据存储机制

### 1. 自动表创建
- 系统启动时会检查 `QualityLevelSettings` 表是否存在
- 如果不存在，会自动创建表结构
- 如果表为空，会自动插入默认数据

### 2. 数据同步
- 前端修改质量等级后，数据会实时同步到数据库
- 支持增删改操作的完整CRUD功能
- 数据变更会更新 `UpdatedAt` 时间戳

### 3. 数据验证
- Grade 字段具有唯一性约束，防止重复等级
- 所有必填字段都有 NOT NULL 约束
- 前端会进行数据格式和完整性验证

## 部署说明

### 新系统部署
1. 执行 `init.sql` 脚本，会自动创建所有必要的表结构
2. 质量等级表会随其他系统表一起创建
3. 默认数据会自动插入

### 现有系统升级
1. 执行 `create_quality_level_settings_table.sql` 脚本
2. 脚本会检查表是否存在，避免重复创建
3. 如果表不存在，会创建表并插入默认数据

## 注意事项

1. **数据持久化**: 质量等级数据存储在数据库中，重启系统不会丢失
2. **数据备份**: 建议定期备份数据库，包括质量等级配置
3. **权限管理**: 质量等级的修改应该有适当的权限控制
4. **数据一致性**: 删除质量等级前应检查是否有相关的返工记录在使用

## 故障排除

### 常见问题

1. **表不存在错误**
   - 解决方案: 执行 `create_quality_level_settings_table.sql` 脚本

2. **数据为空**
   - 解决方案: 检查数据库连接，重新执行初始化脚本

3. **重复等级错误**
   - 解决方案: 检查 Grade 字段的唯一性，避免输入重复等级

### 数据恢复

如果质量等级数据丢失，可以重新执行以下SQL语句恢复默认数据：

```sql
INSERT INTO [dbo].[QualityLevelSettings] ([Grade], [Title], [Description], [Range]) VALUES 
(N'A', N'优秀', N'产品质量完全符合标准，无任何缺陷', N'合格率 ≥ 99%'),
(N'B', N'良好', N'产品质量基本符合标准，存在轻微缺陷', N'合格率 95-99%'),
(N'C', N'一般', N'产品质量勉强符合标准，存在明显缺陷', N'合格率 90-95%'),
(N'D', N'不合格', N'产品质量不符合标准，存在严重缺陷', N'合格率 < 90%');
```